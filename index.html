<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LIFEE - Let Them Argue</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Noto+Sans+SC:wght@400;700&display=swap');

    body {
      font-family: 'Noto Sans SC', sans-serif;
      background-color: #FDFBF7;
    }
    .font-serif { font-family: 'Noto Serif SC', serif; }

    .animate-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .focus-blue-brand:focus {
      outline: none;
      border-color: #98A6D4 !important;
      box-shadow: 0 0 0 3px rgba(152, 166, 212, 0.4);
    }

    .text-blue-brand { color: #98A6D4; }
    .bg-blue-brand { background-color: #98A6D4; }
    .border-blue-brand { border-color: #98A6D4; }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- Icon (Lucide) ---
    const Icon = ({ name, size = 24, className = "" }) => {
      const iconRef = useRef(null);
      useEffect(() => {
        if (iconRef.current && window.lucide) {
          window.lucide.createIcons({
            icons: { [name]: window.lucide[name] },
            attrs: { 'stroke-width': 2, 'width': size, 'height': size }
          });
        }
      }, [name, size]);
      return <i data-lucide={name} className={className} ref={iconRef} style={{ width: size, height: size, display: 'inline-flex' }}></i>;
    };

    const PRESET_PERIODS = [
      "First time studying abroad",
      "First year after graduation",
      "Early career confusion",
      "Career transition",
      "Around 30 ‚Äî feeling stuck",
      "Relationship turning point",
      "Creative burnout",
      "Major failure or loss",
      "Starting over in a new city",
      "Becoming independent"
    ];

    const INITIAL_PERSONAS = [
      {
        id: 'serene',
        name: 'SERENE',
        role: 'THE ARCHIVAL VOICE',
        category: 'CREATIVE',
        worldview: 'A quiet dignity is built from the fragments of a storm.',
        avatar: '‚ú®',
        decisionStyle: "She prioritizes the essential over the urgent, rejecting vanity in favor of structural integrity and emotional honesty.",
        lifeContext: [
          { period: "Shadows of the 1940s", detail: "Found resilience in silence during years of profound scarcity and shared hardship." },
          { period: "Breakout Grace", detail: "Navigated sudden, worldwide visibility with a grounded sense of self and quiet intelligence." }
        ],
        voice: "The simplest plate of pasta, a small square of chocolate, and a long walk are not escapes; they are the anchors of a life well-observed."
      },
      {
        id: 'architect',
        name: 'The Architect',
        role: 'STRATEGIC ANALYST',
        category: 'RATIONAL',
        worldview: 'Life is a series of structural choices and efficiency gains.',
        avatar: 'üìê',
        decisionStyle: "Optimizes for long-term ROI and structural soundness.",
        lifeContext: [
          { period: "System Foundation", detail: "Built internal logic to handle high-pressure environments without emotional distortion." }
        ],
        voice: "A bridge doesn't care about the wind; it cares about the tension."
      },
      {
        id: 'rebel',
        name: 'The Outlier',
        role: 'DISRUPTIVE VOICE',
        category: 'RATIONAL',
        worldview: 'Status quo is the enemy of the soul.',
        avatar: 'üî•',
        lifeContext: [
          { period: "The Departure", detail: "Realized that the traditional path was a slow erosion of identity." }
        ],
        voice: "If it doesn't hurt a little, you're probably lying to yourself."
      },
      {
        id: 'caretaker',
        name: 'The Soft Anchor',
        role: 'EMOTIONAL SUPPORT',
        category: 'SUPPORT',
        worldview: 'Safety and belonging are the bedrock of human existence.',
        avatar: 'üïØÔ∏è',
        lifeContext: [
          { period: "Warmth Reclaimed", detail: "Learning that tenderness is a form of immense and quiet power." }
        ],
        voice: "The warmest room in the world is the one where you are seen."
      }
    ];

    // ‚úÖ LIFEE API (expects JSON { messages: [...], options: [...] })
    const LIFEE_API = "https://lifee-api.guolinn.workers.dev/decision";

    async function fetchLifeeDecision(payload) {
      const res = await fetch(LIFEE_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error("LIFEE API failed: " + text);
      }

      return res.json(); // { messages, options }
    }

    const PageWrapper = ({ children, bgClass = "bg-[#FDFBF7]" }) => (
      <div className={`min-h-screen ${bgClass} text-[#5D576B] p-4 md:p-8 flex flex-col items-center transition-colors duration-500`}>
        <div className="max-w-[1200px] w-full">
          {children}
        </div>
      </div>
    );

    const AvatarDisplay = ({ avatar, className = "" }) => {
      const isImage = avatar?.startsWith('data:image');
      return (
        <div className={`flex items-center justify-center overflow-hidden ${className}`}>
          {isImage
            ? <img src={avatar} alt="Avatar" className="w-full h-full object-cover grayscale" />
            : <span className="text-current leading-none">{avatar}</span>
          }
        </div>
      );
    };

    // --- Persona detail page ---
    const PersonaExpandedPage = ({ persona, onBack, onInvite, isSelected }) => (
      <div className="min-h-screen bg-[#E5E3DF] p-4 md:p-8 flex items-center justify-center font-serif overflow-y-auto animate-in">
        <div className="max-w-4xl w-full bg-[#FAF9F6] shadow-2xl rounded-sm p-6 md:p-12 relative overflow-hidden border border-[#D1CEC7]">
          <div className="absolute top-0 right-0 w-32 h-32 bg-[#98A6D4]/5 rounded-bl-full pointer-events-none" />

          <div className="flex justify-between items-center mb-12 relative z-10 font-sans">
            <button onClick={onBack} className="flex items-center gap-2 text-[10px] uppercase tracking-[0.2em] opacity-40 hover:opacity-100 transition-opacity font-bold">
              <Icon name="ChevronLeft" size={14} /> Back to Selection
            </button>
            <span className="text-[10px] uppercase tracking-widest opacity-30 font-bold">Archive No. {persona.id.toUpperCase()}</span>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-12 mb-16 relative">
            <div className="bg-white p-4 shadow-lg border border-[#F0EDEA] rotate-[-2deg]">
              <AvatarDisplay avatar={persona.avatar} className="aspect-[4/5] bg-neutral-100 text-8xl border-b border-[#F0EDEA]" />
            </div>
            <div className="flex flex-col justify-center">
              <h1 className="text-6xl font-black tracking-tighter text-[#1A1A1A] leading-none mb-4 uppercase italic">{persona.name}</h1>
              <p className="text-sm font-sans font-bold uppercase tracking-[0.3em] text-blue-brand mb-6">{persona.role}</p>
              <p className="text-xl italic leading-relaxed text-[#5D576B]">‚Äú{persona.worldview}‚Äù</p>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16 font-sans">
            <div className="md:col-span-2">
              <div className="p-10 bg-[#FDFBF7] border-2 border-dashed border-[#D1CEC7] rounded-sm space-y-8">
                <div>
                  <h3 className="text-[10px] font-bold uppercase tracking-[0.3em] mb-6 opacity-30">SOUL & WISDOM</h3>
                  <h4 className="text-[10px] font-bold uppercase text-[#D1CEC7] tracking-widest mb-2">DECISION PRIORITIES</h4>
                  <p className="text-sm italic leading-relaxed text-[#1A1A1A]">{persona.decisionStyle || "Grounded and reflective perspective."}</p>
                </div>

                <div className="space-y-6">
                  {persona.lifeContext && persona.lifeContext.map((item, idx) => (
                    <div key={idx} className="flex gap-4 items-start">
                      <span className="text-xs font-mono opacity-20 mt-1">[{idx + 1}]</span>
                      <div>
                        <h5 className="font-bold text-sm text-[#1A1A1A] mb-1">{item.period}</h5>
                        <p className="text-xs opacity-60 leading-relaxed italic">{item.detail}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            <div className="space-y-6">
              <div className="p-8 bg-white border border-[#F0EDEA] shadow-sm flex flex-col items-center">
                <h3 className="text-[10px] font-bold uppercase tracking-[0.3em] opacity-30 mb-6">VOICE</h3>
                <p className="text-sm italic leading-relaxed text-neutral-600 border-l-2 border-neutral-100 pl-4 py-2">
                  {persona.voice}
                </p>
              </div>
            </div>
          </div>

          <div className="pt-12 border-t border-[#D1CEC7] flex flex-col md:flex-row justify-between items-center gap-6 font-sans">
            <p className="text-[10px] italic text-neutral-400 uppercase tracking-widest">This role intervenes selectively, observing silence as closely as words.</p>
            <button
              onClick={() => onInvite(persona)}
              className={`px-12 py-5 rounded-full font-bold uppercase tracking-[0.2em] text-xs transition-all shadow-xl hover:-translate-y-1 ${isSelected ? 'bg-neutral-200 text-neutral-500' : 'bg-blue-brand text-white hover:bg-[#8795c4]'}`}
            >
              {isSelected ? 'IN THE PANEL' : 'INVITE TO DEBATE'}
            </button>
          </div>
        </div>
      </div>
    );

    const PersonaBuilder = ({ onSave, onCancel }) => {
      const [step, setStep] = useState(1);
      const [newP, setNewP] = useState({ name: '', role: '', worldview: '', avatar: 'üë§', voice: '', knowledge: '' });
      const emojis = ['üë§', 'üé≠', 'üõ°Ô∏è', 'üå±', 'ü¶â', 'üíé', 'üå©Ô∏è', 'üåä', 'üî•', 'üéÄ', 'üß∏', '‚òÅÔ∏è'];

      return (
        <PageWrapper bgClass="bg-[#FDFBF7]">
          <div className="max-w-2xl w-full pt-10 font-sans text-left">
            <div className="mb-12 flex items-center justify-between">
              <button onClick={onCancel} className="text-xs font-bold uppercase tracking-widest opacity-40 hover:opacity-100 transition-opacity flex items-center gap-2">
                <Icon name="X" size={14} /> Cancel
              </button>
              <div className="flex gap-2">
                {[1, 2, 3].map(s => (
                  <div key={s} className={`w-3 h-3 rounded-full transition-all duration-300 ${s <= step ? 'bg-blue-brand scale-110 shadow-[0_0_8px_rgba(152,166,212,0.4)]' : 'bg-slate-200'}`} />
                ))}
              </div>
            </div>

            <div className="bg-white p-10 rounded-[60px] shadow-sm border border-[#F0EDEA] space-y-8 animate-in">
              {step === 1 && (
                <div className="space-y-6">
                  <div className="text-center">
                    <h2 className="text-2xl font-serif italic mb-2 uppercase text-[#1A1A1A]">Step 1: Identity</h2>
                  </div>
                  <input
                    placeholder="Name..."
                    className="w-full p-4 bg-[#FDFBF7] rounded-3xl border border-[#F0EDEA] transition-all focus-blue-brand"
                    value={newP.name}
                    onChange={e => setNewP({ ...newP, name: e.target.value })}
                  />
                  <input
                    placeholder="Role / Identity"
                    className="w-full p-4 bg-[#FDFBF7] rounded-3xl border border-[#F0EDEA] uppercase text-sm transition-all focus-blue-brand"
                    value={newP.role}
                    onChange={e => setNewP({ ...newP, role: e.target.value })}
                  />
                  <div className="flex flex-wrap gap-2 justify-center">
                    {emojis.map(e => (
                      <button
                        key={e}
                        onClick={() => setNewP({ ...newP, avatar: e })}
                        className={`p-3 rounded-2xl transition-all border-2 ${newP.avatar === e ? 'border-blue-brand bg-white' : 'border-transparent bg-slate-50'}`}
                      >{e}</button>
                    ))}
                  </div>
                </div>
              )}

              {step === 2 && (
                <div className="space-y-6">
                  <div className="text-center">
                    <h2 className="text-2xl font-serif italic mb-2 uppercase text-[#1A1A1A]">Step 2: Soul</h2>
                  </div>
                  <textarea
                    placeholder="Worldview Statement..."
                    className="w-full h-32 p-5 bg-[#FDFBF7] rounded-[32px] border border-[#F0EDEA] text-sm italic transition-all focus-blue-brand"
                    value={newP.worldview}
                    onChange={e => setNewP({ ...newP, worldview: e.target.value })}
                  />
                  <textarea
                    placeholder="First dialogue sample..."
                    className="w-full h-24 p-5 bg-[#FDFBF7] rounded-[32px] border border-[#F0EDEA] text-sm transition-all focus-blue-brand"
                    value={newP.voice}
                    onChange={e => setNewP({ ...newP, voice: e.target.value })}
                  />
                </div>
              )}

              <div className="flex gap-4">
                {step > 1 && (
                  <button
                    onClick={() => setStep(step - 1)}
                    className="flex-1 py-5 bg-slate-50 text-neutral-400 rounded-full font-bold text-xs uppercase border border-neutral-100 hover:bg-white transition-all"
                  >
                    Back
                  </button>
                )}
                <button
                  onClick={() => step < 3 ? setStep(step + 1) : onSave(newP)}
                  disabled={step === 1 ? (!newP.name || !newP.role) : !newP.worldview}
                  className="flex-[2] py-5 bg-[#1A1A1A] text-white rounded-full font-bold text-xs uppercase shadow-xl disabled:opacity-20 transition-all"
                >
                  {step < 3 ? 'CONTINUE' : 'ARCHIVE VOICE'}
                </button>
              </div>
            </div>
          </div>
        </PageWrapper>
      );
    };

    // ‚úÖ Debate Arena (RESTORED multi-persona + options)
    const DebateArena = ({ context, selectedPersonas, setView }) => {
      const [history, setHistory] = useState([]);
      const [options, setOptions] = useState([]);
      const [isDebating, setIsDebating] = useState(false);
      const scrollRef = useRef(null);

      useEffect(() => {
        if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
      }, [history]);

      const runRound = async (userInput = null) => {
        setIsDebating(true);

        const cleanInput = (userInput ?? "").toString().trim();

        // 1) Áî®Êà∑ËæìÂÖ•ÂÖàÂÜôÂÖ•ÂéÜÂè≤ÔºàÂ¶ÇÊûúÊúâÔºâ
        if (cleanInput) {
          setHistory(prev => [...prev, { personaId: "user", text: cleanInput }]);
        }

        try {
          // 2) ÂèëÁªôÂêéÁ´ØÔºösituation + userInput + personas
          const payload = {
            situation: (context.situation || "").trim() || "Start the internal debate.",
            userInput: cleanInput, // Á©∫‰πüÂèØ‰ª•Ôºàstay silentÔºâ
            personas: selectedPersonas.map(p => ({ id: p.id, name: p.name }))
          };

          const data = await fetchLifeeDecision(payload); // { messages, options }

          // 3) append messages
          if (Array.isArray(data.messages)) {
            setHistory(prev => [...prev, ...data.messages]);
          }

          // 4) set options
          if (Array.isArray(data.options)) {
            setOptions(data.options);
          } else {
            setOptions([]);
          }
        } catch (e) {
          console.error(e);
          setHistory(prev => [...prev, { personaId: "system", text: "ÔºàËØ∑Ê±ÇÂ§±Ë¥•ÔºâËØ∑Ê£ÄÊü• API / CORS / ËøîÂõûÊ†ºÂºè" }]);
          setOptions([]);
        } finally {
          setIsDebating(false);
        }
      };

      // È¶ñËΩÆÔºöËá™Âä®Ëß¶ÂèëÔºàÊó† userInputÔºå‰ΩÜÊúâ situation/personasÔºâ
      useEffect(() => {
        if (history.length === 0) runRound("");
      }, []);

      return (
        <div className="h-screen bg-[#FDFBF7] flex flex-col overflow-hidden font-sans">
          <header className="p-4 border-b border-[#F0EDEA] bg-white flex items-center justify-between z-10 shadow-sm">
            <div className="flex -space-x-2">
              {selectedPersonas.map(p => (
                <div key={p.id} className="w-8 h-8 rounded-full border-2 border-white overflow-hidden shadow-sm">
                  <AvatarDisplay avatar={p.avatar} className="w-full h-full text-xs" />
                </div>
              ))}
            </div>
            <button
              onClick={() => setView('summary')}
              className="flex items-center gap-2 text-xs font-bold text-[#E6C6C1] px-4 py-2 border border-[#E6C6C1] rounded-full hover:bg-[#E6C6C1] hover:text-white transition-all"
            >
              <Icon name="PauseCircle" size={14} /> STOP & DECIDE
            </button>
          </header>

          <div ref={scrollRef} className="flex-1 overflow-y-auto p-6 space-y-10 pb-60 no-scrollbar">
            {history.map((m, idx) => {
              const isUser = m.personaId === 'user';

              const persona = isUser
                ? { name: "YOU", avatar: "üë§" }
                : (selectedPersonas.find(p => p.id === m.personaId) ||
                   (m.personaId === "system" ? { name: "SYSTEM", avatar: "‚ö†Ô∏è" } : { name: "Voice", avatar: "‚òÅÔ∏è" }));

              return (
                <div key={idx} className={`flex gap-4 ${isUser ? 'flex-row-reverse' : 'items-start'} animate-in`}>
                  <div className={`w-10 h-10 rounded-full border flex items-center justify-center shadow-sm shrink-0 bg-white overflow-hidden ${isUser ? 'border-blue-brand/20' : 'border-[#F0EDEA]'}`}>
                    <AvatarDisplay avatar={persona.avatar} className="w-full h-full text-2xl" />
                  </div>
                  <div className={`max-w-[75%] flex flex-col ${isUser ? 'items-end' : 'items-start'}`}>
                    <span className="text-[10px] font-bold opacity-30 tracking-widest uppercase mb-1">{persona.name}</span>
                    <div className={`p-4 rounded-3xl text-sm shadow-sm transition-all duration-300 ${isUser ? 'bg-blue-brand text-white rounded-tr-none' : 'bg-white border border-[#F0EDEA] rounded-tl-none'}`}>
                      {m.text}
                    </div>
                  </div>
                </div>
              );
            })}

            {isDebating && (
              <div className="animate-pulse flex gap-4 mt-10">
                <div className="w-10 h-10 bg-slate-100 rounded-full" />
                <div className="h-12 w-48 bg-white border rounded-3xl" />
              </div>
            )}
          </div>

          <div className="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-[#FDFBF7] via-[#FDFBF7] to-transparent z-20">
            <div className="max-w-2xl mx-auto space-y-4">
              {options.length > 0 && !isDebating && (
                <div className="flex flex-wrap justify-center gap-2 mb-4 animate-in">
                  {options.map((opt, i) => (
                    <button
                      key={i}
                      onClick={() => { setOptions([]); runRound(opt); }}
                      className="px-4 py-2 bg-white/90 border-2 border-blue-brand/20 rounded-full text-xs font-medium hover:bg-blue-brand hover:text-white transition-all shadow-sm"
                    >
                      {opt}
                    </button>
                  ))}
                </div>
              )}

              <div className="flex gap-4">
                <button
                  disabled={isDebating}
                  onClick={() => runRound("")}
                  className="flex-1 py-5 bg-blue-brand text-white rounded-full font-bold shadow-xl transition-all hover:translate-y-[-2px] disabled:opacity-50"
                >
                  STAY SILENT
                </button>

                <div className="relative flex-[1.5] group">
                  <input
                    type="text"
                    placeholder="..."
                    disabled={isDebating}
                    className="w-full h-14 bg-white rounded-full shadow-xl border-2 border-[#F0EDEA] transition-all duration-300 px-6 focus-blue-brand text-sm"
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' && e.target.value.trim()) {
                        runRound(e.target.value);
                        e.target.value = '';
                      }
                    }}
                  />
                  <div className="absolute inset-y-0 right-6 flex items-center pointer-events-none group-focus-within:opacity-0 transition-opacity">
                    <Icon name="MessageCircle" size={20} className="text-blue-brand" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    function App() {
      const [view, setView] = useState('home');
      const [category, setCategory] = useState('ALL');
      const [context, setContext] = useState({ situation: '', landingPeriods: [] });
      const [personas, setPersonas] = useState(INITIAL_PERSONAS);
      const [selectedIds, setSelectedIds] = useState([]);
      const [detailPersona, setDetailPersona] = useState(null);

      const toggleSelect = (e, p) => {
        e.stopPropagation();
        setSelectedIds(prev => prev.includes(p.id) ? prev.filter(id => id !== p.id) : [...prev, p.id]);
      };

      const filtered = category === 'ALL' ? personas : personas.filter(p => p.category === category);

      if (view === 'builder') return (
        <PersonaBuilder
          onSave={(newP) => { setPersonas([...personas, { ...newP, id: `custom-${Date.now()}`, category: 'CUSTOM' }]); setView('persona-selection'); }}
          onCancel={() => setView('persona-selection')}
        />
      );

      if (view === 'persona-detail') return (
        <PersonaExpandedPage
          persona={detailPersona}
          onBack={() => setView('persona-selection')}
          onInvite={(p) => { if (!selectedIds.includes(p.id)) setSelectedIds([...selectedIds, p.id]); setView('persona-selection'); }}
          isSelected={selectedIds.includes(detailPersona?.id)}
        />
      );

      if (view === 'persona-selection') return (
        <PageWrapper bgClass="bg-[#FDFBF7]">
          <div className="mb-12 flex justify-between items-center px-4 w-full">
            <button onClick={() => setView('home')} className="flex items-center gap-2 text-[10px] font-bold uppercase tracking-[0.25em] opacity-40 hover:opacity-100 transition-all">
              <Icon name="ChevronLeft" size={14} /> Retreat
            </button>
            <div className="text-[10px] uppercase tracking-[0.25em] opacity-40 font-bold">Panel: {selectedIds.length}</div>
          </div>

          <div className="flex justify-center mb-16 px-4">
            <div className="inline-flex bg-[#E8E8E8]/50 backdrop-blur-md p-1.5 rounded-full border-2 border-white shadow-lg">
              {['ALL', 'CREATIVE', 'RATIONAL', 'SUPPORT', 'CUSTOM'].map(cat => (
                <button
                  key={cat}
                  onClick={() => setCategory(cat)}
                  className={`px-8 py-2.5 rounded-full text-[10px] font-black uppercase tracking-[0.15em] transition-all duration-300 ${category === cat ? 'bg-blue-brand text-white shadow-lg scale-105' : 'text-[#5D576B]/60 hover:text-blue-brand'}`}
                >
                  {cat}
                </button>
              ))}
            </div>
          </div>

          <h2 className="text-4xl md:text-5xl font-serif italic mb-16 text-[#5D576B] px-4 tracking-tight text-center animate-in">Assemble the Voices</h2>

          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-8 mb-40 px-4 w-full animate-in">
            {filtered.map(p => {
              const isSel = selectedIds.includes(p.id);
              return (
                <div
                  key={p.id}
                  onClick={() => { setDetailPersona(p); setView('persona-detail'); }}
                  className={`relative p-8 bg-white rounded-[40px] shadow-2xl border-2 transition-all transform hover:scale-[1.03] flex flex-col aspect-[3/4] min-h-[320px] overflow-hidden group ${isSel ? 'border-blue-brand' : 'border-[#F0EDEA]'}`}
                >
                  <button
                    onClick={(e) => toggleSelect(e, p)}
                    className={`absolute top-6 right-6 w-11 h-11 rounded-full border-2 flex items-center justify-center z-30 transition-all ${isSel ? 'bg-blue-brand border-blue-brand shadow-lg scale-110' : 'bg-transparent border-slate-100 group-hover:border-blue-brand/40'}`}
                  >
                    {isSel && <Icon name="Check" size={18} className="text-white" />}
                  </button>

                  <div className="mb-6 flex items-center justify-center w-16 h-16 relative overflow-hidden group-hover:scale-110 transition-transform origin-center">
                    <div className="absolute inset-0 bg-slate-50 rounded-[24px] transform rotate-6 scale-90 opacity-40" />
                    <AvatarDisplay avatar={p.avatar} className="w-12 h-12 text-4xl relative z-10" />
                  </div>

                  <div className="mt-auto text-left">
                    <h4 className="font-bold text-xl text-[#1A1A1A] tracking-tighter mb-1 leading-tight">{p.name}</h4>
                    <p className="text-[8px] uppercase font-black tracking-[0.1em] text-blue-brand mb-3">{p.role}</p>
                    <p className="text-xs italic leading-relaxed text-black/40 line-clamp-2">‚Äú{p.worldview}‚Äù</p>
                  </div>

                  {p.id.startsWith('custom-') && (
                    <button
                      onClick={(e) => { e.stopPropagation(); setPersonas(personas.filter(x => x.id !== p.id)); }}
                      className="absolute bottom-6 left-6 p-2 text-neutral-200 hover:text-red-400 transition-all z-20"
                    >
                      <Icon name="Trash2" size={16} />
                    </button>
                  )}
                </div>
              );
            })}

            {(category === 'ALL' || category === 'CUSTOM') && (
              <div
                onClick={() => setView('builder')}
                className="relative p-6 bg-white/30 backdrop-blur-sm rounded-[40px] border-2 border-dashed border-[#D1CEC7] cursor-pointer transition-all hover:bg-white/50 flex flex-col items-center justify-center gap-4 aspect-[3/4] min-h-[320px] text-center group"
              >
                <div className="w-12 h-12 rounded-full bg-white shadow-md flex items-center justify-center text-blue-brand group-hover:scale-110 transition-transform">
                  <Icon name="Plus" size={24} />
                </div>
                <p className="text-[10px] font-black uppercase tracking-[0.3em] text-[#5D576B] opacity-40">Create Voice</p>
              </div>
            )}
          </div>

          {selectedIds.length >= 2 && (
            <div className="fixed bottom-12 left-1/2 -translate-x-1/2 w-full max-w-sm px-6 z-30 animate-in">
              <button
                onClick={() => setView('debate')}
                className="w-full py-6 bg-black text-white rounded-full font-bold text-[10px] tracking-[0.3em] shadow-2xl hover:scale-105 active:scale-95 transition-all uppercase"
              >
                Commence Dialogue
              </button>
            </div>
          )}
        </PageWrapper>
      );

      if (view === 'debate') return (
        <DebateArena
          context={context}
          selectedPersonas={personas.filter(p => selectedIds.includes(p.id))}
          setView={setView}
        />
      );

      if (view === 'summary') return (
        <PageWrapper bgClass="bg-[#FDFBF7]">
          <div className="text-center py-40 animate-in">
            <div className="text-6xl mb-12">üå±</div>
            <h2 className="text-4xl font-serif italic mb-6 text-[#1A1A1A]">Your Decision</h2>
            <button onClick={() => window.location.reload()} className="w-full py-5 bg-blue-brand text-white rounded-full font-bold shadow-xl uppercase tracking-widest text-xs">
              Start New Chapter
            </button>
          </div>
        </PageWrapper>
      );

      return (
        <PageWrapper bgClass="bg-[#FDFBF7]">
          <header className="mb-20 text-center animate-in">
            <h1 className="text-6xl font-bold tracking-[0.1em] text-blue-brand mb-3 uppercase italic">LIFEE</h1>
            <p className="italic text-[10px] text-[#C1C1C1] uppercase tracking-[0.4em] font-black font-sans">YOUR LIFE & FRIEND COACH</p>
          </header>

          <section className="space-y-12 mb-20 max-w-3xl mx-auto w-full animate-in font-sans">
            <div className="bg-white p-12 rounded-[60px] shadow-sm border border-[#F0EDEA] text-center relative overflow-hidden">
              <div className="absolute top-0 right-0 p-10 opacity-5"><Icon name="Sparkles" size={48} /></div>
              <h2 className="text-2xl font-serif italic mb-6 text-[#1A1A1A]">‚ÄúLet them argue, you decide.‚Äù</h2>
              <textarea
                className="w-full h-40 p-6 bg-white rounded-3xl border-2 border-[#F0EDEA] transition-all focus-blue-brand text-base leading-relaxed placeholder:italic"
                placeholder="Where are you right now? Share your situation..."
                value={context.situation}
                onChange={(e) => setContext({ ...context, situation: e.target.value })}
              />
            </div>

            <div className="space-y-6 px-4 text-center">
              <h3 className="text-xs font-bold uppercase tracking-[0.2em] text-blue-brand opacity-80 mb-4 uppercase">When is this landing?</h3>
              <div className="flex flex-wrap justify-center gap-3">
                {PRESET_PERIODS.map(p => (
                  <button
                    key={p}
                    onClick={() => setContext(prev => ({ ...prev, landingPeriods: prev.landingPeriods.includes(p) ? prev.landingPeriods.filter(x => x !== p) : [...prev.landingPeriods, p] }))}
                    className={`px-6 py-3 rounded-full text-[11px] font-bold transition-all border-2 ${context.landingPeriods.includes(p) ? 'bg-blue-brand text-white border-blue-brand shadow-lg scale-105' : 'bg-white text-neutral-300 border-[#F0EDEA] hover:border-blue-brand/40'}`}
                  >
                    {p}
                  </button>
                ))}
              </div>
            </div>

            <button
              disabled={!context.situation}
              onClick={() => setView('persona-selection')}
              className="w-full py-6 bg-blue-brand text-white rounded-full font-bold shadow-xl transition-all hover:translate-y-[-1px] uppercase tracking-widest text-sm disabled:opacity-40"
            >
              Step Forward
            </button>
          </section>
        </PageWrapper>
      );
    }

    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
  </script>
</body>
</html>