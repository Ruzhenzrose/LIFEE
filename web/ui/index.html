<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFEE - Let Them Argue</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Noto+Sans+SC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #FDFBF7;
            color: #5D576B;
            margin: 0;
            overflow: hidden;
        }
        .font-serif {
            font-family: 'Noto Serif SC', serif;
        }
        .animate-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .focus-blue-brand:focus {
            outline: none;
            border-color: #98A6D4 !important;
            box-shadow: 0 0 0 3px rgba(152, 166, 212, 0.3);
        }

        .text-blue-brand { color: #98A6D4; }
        .bg-blue-brand { background-color: #98A6D4; }
        .border-blue-brand { border-color: #98A6D4; }

        /* ‰æßËæπÊ†èËøáÊ∏° */
        .sidebar-transition {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const PRESET_PERIODS = [
            "First time studying abroad",
            "First year after graduation",
            "Early career confusion",
            "Career transition",
            "Around 30 ‚Äî feeling stuck",
            "Relationship turning point",
            "Creative burnout",
            "Major failure or loss",
            "Starting over in a new city",
            "Becoming independent"
        ];

        const INITIAL_PERSONAS = [
            {
                id: 'serene',
                name: 'SERENE',
                role: 'THE ARCHIVAL VOICE',
                category: 'CREATIVE',
                worldview: 'A quiet dignity is built from the fragments of a storm.',
                avatar: '‚ú®',
                decisionStyle: "She prioritizes the essential over the urgent.",
                lifeContext: [
                    { period: "Shadows of the 1940s", detail: "Found resilience in silence during scarcity." },
                    { period: "Breakout Grace", detail: "Navigated visibility with grounded intelligence." }
                ],
                voice: "The simplest plate of pasta and a long walk are anchors of a life well-observed."
            },
            {
                id: 'architect',
                name: 'The Architect',
                role: 'STRATEGIC ANALYST',
                category: 'RATIONAL',
                worldview: 'Life is a series of structural choices and efficiency gains.',
                avatar: 'üìê',
                decisionStyle: "Optimizes for long-term ROI and structural soundness.",
                lifeContext: [
                    { period: "System Foundation", detail: "Built internal logic to handle high-pressure environments." }
                ],
                voice: "A bridge doesn't care about the wind; it cares about the tension."
            },
            {
                id: 'rebel',
                name: 'The Outlier',
                role: 'DISRUPTIVE VOICE',
                category: 'RATIONAL',
                worldview: 'Status quo is the enemy of the soul.',
                avatar: 'üî•',
                voice: "If it doesn't hurt a little, you're probably lying to yourself."
            },
            {
                id: 'caretaker',
                name: 'The Soft Anchor',
                role: 'EMOTIONAL SUPPORT',
                category: 'SUPPORT',
                worldview: 'Safety and belonging are the bedrock of human existence.',
                avatar: 'üïØÔ∏è',
                voice: "The warmest room in the world is the one where you are seen."
            }
        ];

        const API_KEY = ""; 
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";

        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current && window.lucide) {
                    window.lucide.createIcons({
                        icons: { [name]: window.lucide[name] },
                        attrs: { 'stroke-width': 2, 'width': size, 'height': size }
                    });
                }
            }, [name, size]);
            return <i data-lucide={name} className={className} ref={iconRef} style={{ width: size, height: size, display: 'inline-flex' }}></i>;
        };

        const AvatarDisplay = ({ avatar, className = "" }) => {
            const isImage = avatar?.startsWith('data:image');
            return (
                <div className={`flex items-center justify-center overflow-hidden ${className}`}>
                    {isImage ? (
                        <img src={avatar} alt="Avatar" className="w-full h-full object-cover grayscale" />
                    ) : (
                        <span className="text-current leading-none">{avatar}</span>
                    )}
                </div>
            );
        };

        async function fetchGemini(prompt, systemInstruction) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
            const payload = { 
                contents: [{ role: "user", parts: [{ text: prompt }] }], 
                systemInstruction: { parts: [{ text: systemInstruction }] } 
            };
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
            } catch (e) { return "{}"; }
        }

        // ‚úÖ LIFEE API (‰øùÁïôÂéüÊúâÁöÑ API Ë∞ÉÁî®Ôºå‰æõ DebateArena ‰ΩøÁî®)
        const LIFEE_API = "https://lifee-api.guolinn.workers.dev/decision";

        async function fetchLifeeDecision(payload) {
            const res = await fetch(LIFEE_API, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const text = await res.text();
                throw new Error("LIFEE API failed: " + text);
            }

            return res.json(); // { messages, options }
        }

        // ‚úÖ Debate Arena (‰øùÁïôÂéüÊúâÁöÑËæ©ËÆ∫ÁªÑ‰ª∂)
        const DebateArena = ({ context, selectedPersonas, setView }) => {
            const [history, setHistory] = useState([]);
            const [options, setOptions] = useState([]);
            const [isDebating, setIsDebating] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => {
                if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
            }, [history]);

            const runRound = async (userInput = null) => {
                setIsDebating(true);

                const cleanInput = (userInput ?? "").toString().trim();

                // 1) Áî®Êà∑ËæìÂÖ•ÂÖàÂÜôÂÖ•ÂéÜÂè≤ÔºàÂ¶ÇÊûúÊúâÔºâ
                if (cleanInput) {
                    setHistory(prev => [...prev, { personaId: "user", text: cleanInput }]);
                }

                try {
                    // 2) ÂèëÁªôÂêéÁ´ØÔºösituation + userInput + personas
                    const payload = {
                        situation: (context.situation || "").trim() || "Start the internal debate.",
                        userInput: cleanInput, // Á©∫‰πüÂèØ‰ª•Ôºàstay silentÔºâ
                        personas: selectedPersonas.map(p => ({ id: p.id, name: p.name }))
                    };

                    const data = await fetchLifeeDecision(payload); // { messages, options }

                    // 3) append messages
                    if (Array.isArray(data.messages)) {
                        setHistory(prev => [...prev, ...data.messages]);
                    }

                    // 4) set options
                    if (Array.isArray(data.options)) {
                        setOptions(data.options);
                    } else {
                        setOptions([]);
                    }
                } catch (e) {
                    console.error(e);
                    setHistory(prev => [...prev, { personaId: "system", text: "ÔºàËØ∑Ê±ÇÂ§±Ë¥•ÔºâËØ∑Ê£ÄÊü• API / CORS / ËøîÂõûÊ†ºÂºè" }]);
                    setOptions([]);
                } finally {
                    setIsDebating(false);
                }
            };

            // È¶ñËΩÆÔºöËá™Âä®Ëß¶ÂèëÔºàÊó† userInputÔºå‰ΩÜÊúâ situation/personasÔºâ
            useEffect(() => {
                if (history.length === 0) runRound("");
            }, []);

            return (
                <div className="h-[calc(100vh-64px)] flex flex-col overflow-hidden font-sans animate-in">
                    <header className="p-4 border-b border-[#F0EDEA] bg-white flex items-center justify-between z-10">
                        <div className="flex -space-x-2">
                            {selectedPersonas.map(p => (
                                <div key={p.id} className="w-8 h-8 rounded-full border-2 border-white overflow-hidden shadow-sm">
                                    <AvatarDisplay avatar={p.avatar} className="w-full h-full text-xs" />
                                </div>
                            ))}
                        </div>
                        <button
                            onClick={() => setView('summary')}
                            className="flex items-center gap-2 text-xs font-bold text-[#E6C6C1] px-4 py-2 border border-[#E6C6C1] rounded-full hover:bg-[#E6C6C1] hover:text-white transition-all"
                        >
                            <Icon name="PauseCircle" size={14} /> STOP & DECIDE
                        </button>
                    </header>

                    <div ref={scrollRef} className="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 md:space-y-12 pb-64 no-scrollbar">
                        {history.map((m, idx) => {
                            const isUser = m.personaId === 'user';

                            const persona = isUser
                                ? { name: "YOU", avatar: "üë§" }
                                : (selectedPersonas.find(p => p.id === m.personaId) ||
                                    (m.personaId === "system" ? { name: "SYSTEM", avatar: "‚ö†Ô∏è" } : { name: "Voice", avatar: "‚òÅÔ∏è" }));

                            return (
                                <div key={idx} className={`flex gap-3 md:gap-4 ${isUser ? 'flex-row-reverse' : 'items-start'} animate-in`}>
                                    <div className={`w-8 h-8 md:w-10 md:h-10 rounded-full border flex items-center justify-center shadow-sm shrink-0 bg-white overflow-hidden ${isUser ? 'border-blue-brand/20' : 'border-[#F0EDEA]'}`}>
                                        <AvatarDisplay avatar={persona.avatar} className="w-full h-full text-xl md:text-2xl" />
                                    </div>
                                    <div className={`max-w-[85%] md:max-w-[75%] flex flex-col ${isUser ? 'items-end' : 'items-start'}`}>
                                        <span className="text-[9px] md:text-[10px] font-bold opacity-30 tracking-widest uppercase mb-1">{persona.name}</span>
                                        <div className={`p-3 md:p-4 rounded-3xl text-sm shadow-sm transition-all duration-300 ${isUser ? 'bg-blue-brand text-white rounded-tr-none' : 'bg-white border border-[#F0EDEA] rounded-tl-none'}`}>
                                            {m.text}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}

                        {isDebating && (
                            <div className="animate-pulse flex gap-4 mt-10">
                                <div className="w-10 h-10 bg-slate-100 rounded-full" />
                                <div className="h-12 w-48 bg-white border rounded-3xl" />
                            </div>
                        )}
                    </div>

                    <div className="p-4 md:p-8 bg-gradient-to-t from-[#FDFBF7] via-[#FDFBF7] to-transparent">
                        <div className="max-w-3xl mx-auto space-y-4 md:space-y-5">
                            {options.length > 0 && !isDebating && (
                                <div className="flex flex-wrap justify-center gap-2 mb-4 animate-in">
                                    {options.map((opt, i) => (
                                        <button
                                            key={i}
                                            onClick={() => { setOptions([]); runRound(opt); }}
                                            className="px-4 py-2 md:px-5 md:py-2.5 bg-white/90 border border-blue-brand/20 rounded-full text-xs font-bold hover:bg-blue-brand hover:text-white transition-all shadow-sm"
                                        >
                                            {opt}
                                        </button>
                                    ))}
                                </div>
                            )}

                            <div className="flex gap-2 md:gap-4">
                                <button
                                    disabled={isDebating}
                                    onClick={() => runRound("")}
                                    className="flex-1 py-4 md:py-5 bg-blue-brand text-white rounded-full font-bold shadow-xl transition-all hover:translate-y-[-2px] disabled:opacity-50 uppercase tracking-widest text-[10px] md:text-xs"
                                >
                                    STAY SILENT
                                </button>

                                <div className="relative flex-[2] group">
                                    <input
                                        type="text"
                                        placeholder="..."
                                        disabled={isDebating}
                                        className="w-full h-12 md:h-14 bg-white rounded-full shadow-xl border-2 border-transparent focus:border-blue-brand transition-all duration-300 px-6 md:px-8 focus:outline-none text-sm"
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter' && e.target.value.trim()) {
                                                runRound(e.target.value);
                                                e.target.value = '';
                                            }
                                        }}
                                    />
                                    <div className="absolute inset-y-0 right-4 md:right-6 flex items-center pointer-events-none group-focus-within:opacity-0 transition-opacity">
                                        <Icon name="MessageCircle" size={20} className="text-blue-brand" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- ÂìçÂ∫îÂºèÂ∏ÉÂ±ÄÁªÑ‰ª∂ ---
        const AppLayout = ({ children, activeView, setView, isLoggedIn, onLogin, onNewChat }) => {
            const [isCollapsed, setIsCollapsed] = useState(true);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

            const handleMobileNewChat = () => {
                onNewChat();
                setIsMobileMenuOpen(false);
            };

            return (
                <div className="flex h-screen overflow-hidden bg-[#FDFBF7]">
                    {/* ËÉåÊôØÈÅÆÁΩ© (‰ªÖÁßªÂä®Á´ØÂèØËßÅ) */}
                    {isMobileMenuOpen && (
                        <div 
                            className="fixed inset-0 bg-black/20 backdrop-blur-sm z-40 md:hidden"
                            onClick={() => setIsMobileMenuOpen(false)}
                        />
                    )}

                    {/* Sidebar */}
                    <aside className={`
                        sidebar-transition fixed inset-y-0 left-0 z-50 bg-[#F8F6F2] border-r border-[#E8E6E0] flex flex-col p-4
                        md:relative md:translate-x-0
                        ${isMobileMenuOpen ? 'translate-x-0 w-[280px]' : '-translate-x-full w-[280px] md:translate-x-0'}
                        ${!isCollapsed ? 'md:w-[260px]' : 'md:w-[72px]'}
                    `}>
                        <div className="flex-1 overflow-y-auto no-scrollbar flex flex-col">
                            {/* Expand/Collapse Menu ÊåâÈíÆ */}
                            <button 
                                onClick={() => setIsCollapsed(!isCollapsed)}
                                className="p-3 mb-4 rounded-xl hover:bg-white/60 transition-all text-blue-brand self-start hidden md:block"
                            >
                                <Icon name="Menu" size={20} />
                            </button>

                            {/* ÁßªÂä®Á´ØÂÖ≥Èó≠ÊåâÈíÆ */}
                            <button 
                                onClick={() => setIsMobileMenuOpen(false)}
                                className="p-3 mb-4 rounded-xl hover:bg-white/60 text-blue-brand md:hidden self-end"
                            >
                                <Icon name="X" size={20} />
                            </button>

                            {/* New Chat */}
                            <button 
                                onClick={handleMobileNewChat}
                                className={`flex items-center gap-3 bg-white border border-[#E8E6E0] rounded-2xl shadow-sm hover:shadow-md transition-all font-bold text-[#5D576B] ${isCollapsed ? 'md:p-3 md:justify-center mb-8' : 'px-6 py-4 mb-8 text-sm'}`}
                            >
                                <Icon name="Plus" size={20} className="text-blue-brand" />
                                <span className={isCollapsed ? 'md:hidden' : 'block'}>New Chat</span>
                            </button>
                            
                            <nav className="space-y-1">
                                <div className={`text-[10px] uppercase font-bold tracking-widest opacity-30 px-4 mb-2 ${isCollapsed ? 'md:hidden' : 'block'}`}>History</div>
                                <button className={`w-full text-left rounded-xl hover:bg-white/60 transition-colors flex items-center ${isCollapsed ? 'md:p-3 md:justify-center' : 'px-4 py-3 text-xs opacity-60 italic truncate'}`}>
                                    <Icon name="MessageSquare" size={14} className={isCollapsed ? "md:text-blue-brand" : "mr-2 opacity-40"} />
                                    <span className={isCollapsed ? 'md:hidden' : 'block'}>"Recent thoughts..."</span>
                                </button>
                            </nav>
                        </div>

                        <div className="pt-4 border-t border-[#E8E6E0] space-y-1">
                            <button className={`w-full flex items-center font-bold hover:bg-white/60 rounded-xl transition-all ${isCollapsed ? 'md:p-3 md:justify-center' : 'gap-3 px-4 py-2.5 text-xs'}`}>
                                <Icon name="HelpCircle" size={18} />
                                <span className={isCollapsed ? 'md:hidden' : 'block'}>Help</span>
                            </button>
                            <button className={`w-full flex items-center font-bold hover:bg-white/60 rounded-xl transition-all ${isCollapsed ? 'md:p-3 md:justify-center' : 'gap-3 px-4 py-2.5 text-xs'}`}>
                                <Icon name="Settings" size={18} />
                                <span className={isCollapsed ? 'md:hidden' : 'block'}>Settings</span>
                            </button>
                        </div>
                    </aside>

                    {/* Main Area */}
                    <div className="flex-1 flex flex-col overflow-hidden relative">
                        <header className="h-16 flex items-center justify-between px-4 md:px-8 bg-[#FDFBF7]/80 backdrop-blur-md z-30 sticky top-0 border-b border-[#E8E6E0]/30">
                            <div className="flex items-center gap-3">
                                {/* ÁßªÂä®Á´ØËèúÂçïÂºÄÂÖ≥ */}
                                <button onClick={() => setIsMobileMenuOpen(true)} className="p-2 md:hidden text-blue-brand">
                                    <Icon name="Menu" size={24} />
                                </button>
                                <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView('home')}>
                                    <span className="font-serif italic font-black text-blue-brand tracking-tighter text-xl md:text-2xl">LIFEE</span>
                                </div>
                            </div>

                            <div className="flex items-center gap-3 md:gap-8">
                                <button 
                                    onClick={() => setView('community')}
                                    className={`text-[9px] md:text-[10px] font-black uppercase tracking-[0.1em] md:tracking-[0.2em] transition-all hover:text-blue-brand ${activeView === 'community' ? 'text-blue-brand underline underline-offset-8' : 'text-[#5D576B]/60'}`}
                                >
                                    Community
                                </button>
                                
                                {isLoggedIn ? (
                                    <div className="w-8 h-8 md:w-9 md:h-9 rounded-full bg-blue-brand text-white border-2 border-white shadow-lg flex items-center justify-center">
                                        <Icon name="User" size={16} />
                                    </div>
                                ) : (
                                    <button 
                                        onClick={onLogin}
                                        className="px-4 py-1.5 md:px-8 md:py-2.5 bg-blue-brand text-white rounded-full text-[9px] md:text-[10px] font-black uppercase tracking-widest shadow-lg active:scale-95"
                                    >
                                        Sign In
                                    </button>
                                )}
                            </div>
                        </header>

                        <main className="flex-1 overflow-y-auto no-scrollbar">
                            <div className="w-full max-w-[1400px] mx-auto">
                                {children}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        // --- Â≠êÈ°µÈù¢ÁªÑ‰ª∂ (ÂìçÂ∫îÂºè‰ºòÂåñ) ---
        const PersonaBuilder = ({ onSave, onCancel }) => {
            const [step, setStep] = useState(1);
            const [newP, setNewP] = useState({ name: '', role: '', worldview: '', avatar: 'üë§', voice: '', knowledge: '' });
            const emojis = ['üë§', 'üé≠', 'üõ°Ô∏è', 'üå±', 'ü¶â', 'üíé', 'üå©Ô∏è', 'üåä', 'üî•', 'üéÄ', 'üß∏', '‚òÅÔ∏è'];

            return (
                <div className="max-w-2xl mx-auto w-full pt-8 md:pt-12 px-4 font-sans animate-in">
                    <div className="mb-8 flex items-center justify-between">
                        <button onClick={onCancel} className="text-[10px] font-bold uppercase tracking-widest opacity-40 flex items-center gap-2"><Icon name="X" size={14} /> Cancel</button>
                        <div className="flex gap-2">
                            {[1, 2, 3].map(s => <div key={s} className={`w-2.5 h-2.5 rounded-full ${s <= step ? 'bg-blue-brand shadow-[0_0_8px_rgba(152,166,212,0.4)]' : 'bg-slate-200'}`} />)}
                        </div>
                    </div>
                    <div className="bg-white p-6 md:p-12 rounded-[40px] md:rounded-[60px] shadow-sm border border-[#F0EDEA] space-y-8">
                        {step === 1 && (
                            <div className="space-y-6">
                                <h2 className="text-xl md:text-2xl font-serif italic text-center uppercase text-[#1A1A1A]">Step 1: Identity</h2>
                                <input placeholder="Name..." className="w-full p-4 bg-[#FDFBF7] rounded-2xl border border-[#F0EDEA] focus-blue-brand" value={newP.name} onChange={e => setNewP({...newP, name: e.target.value})} />
                                <input placeholder="Role / Identity" className="w-full p-4 bg-[#FDFBF7] rounded-2xl border border-[#F0EDEA] uppercase text-xs focus-blue-brand" value={newP.role} onChange={e => setNewP({...newP, role: e.target.value})} />
                                <div className="flex flex-wrap gap-2 justify-center pt-2">
                                    {emojis.map(e => <button key={e} onClick={() => setNewP({...newP, avatar: e})} className={`p-3 rounded-xl transition-all border-2 ${newP.avatar === e ? 'border-blue-brand bg-white' : 'border-transparent bg-slate-50'}`}>{e}</button>)}
                                </div>
                            </div>
                        )}
                        {step === 2 && (
                            <div className="space-y-6">
                                <h2 className="text-xl md:text-2xl font-serif italic text-center uppercase">Step 2: Soul</h2>
                                <textarea placeholder="Worldview Statement..." className="w-full h-32 p-5 bg-[#FDFBF7] rounded-2xl border border-[#F0EDEA] text-sm italic focus-blue-brand" value={newP.worldview} onChange={e => setNewP({...newP, worldview: e.target.value})} />
                                <textarea placeholder="Voice Sample..." className="w-full h-24 p-5 bg-[#FDFBF7] rounded-2xl border border-[#F0EDEA] text-sm focus-blue-brand" value={newP.voice} onChange={e => setNewP({...newP, voice: e.target.value})} />
                            </div>
                        )}
                        <div className="flex gap-3">
                            {step > 1 && <button onClick={() => setStep(step-1)} className="flex-1 py-4 bg-slate-50 text-neutral-400 rounded-full font-bold text-xs uppercase border">Back</button>}
                            <button onClick={() => step < 2 ? setStep(step+1) : onSave(newP)} disabled={step === 1 ? (!newP.name || !newP.role) : !newP.worldview} className="flex-[2] py-4 bg-[#1A1A1A] text-white rounded-full font-bold text-xs uppercase shadow-xl disabled:opacity-20 transition-all">
                                {step < 2 ? 'CONTINUE' : 'ARCHIVE VOICE'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('home'); 
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [context, setContext] = useState({ situation: '', landingPeriods: [] });
            const [personas, setPersonas] = useState(INITIAL_PERSONAS);
            const [selectedIds, setSelectedIds] = useState([]);
            const [detailPersona, setDetailPersona] = useState(null);
            const [category, setCategory] = useState('ALL');
            const [communityTab, setCommunityTab] = useState('DEBATE');

            const handleNewChat = () => {
                setContext({ situation: '', landingPeriods: [] });
                setSelectedIds([]);
                setView('home');
            };

            const toggleSelect = (e, p) => {
                e.stopPropagation();
                setSelectedIds(prev => prev.includes(p.id) ? prev.filter(id => id !== p.id) : [...prev, p.id]);
            };

            const renderContent = () => {
                if (view === 'community') return (
                    <div className="p-6 md:p-12 max-w-[1200px] mx-auto animate-in space-y-12">
                        <div className="flex flex-col items-center space-y-6">
                            <h2 className="text-3xl md:text-5xl font-serif italic tracking-tight text-center">Community Archives</h2>
                            
                            {/* Á§æÂå∫È°µÈù¢ÂàÜÁ±ªÊù° */}
                            <div className="flex justify-center px-4 w-full">
                                <div className="inline-flex bg-white/60 backdrop-blur-md p-1.5 rounded-full border-2 border-white shadow-lg whitespace-nowrap">
                                    {[
                                        {id: 'DEBATE', label: 'DEBATE', desc: 'Chat reflections'},
                                        {id: 'PERSONA', label: 'PERSONA', desc: 'Shared voices'}
                                    ].map(tab => (
                                        <button 
                                            key={tab.id} 
                                            onClick={() => setCommunityTab(tab.id)} 
                                            className={`px-8 md:px-12 py-2.5 md:py-3 rounded-full text-[10px] font-black uppercase tracking-[0.2em] transition-all duration-300 ${communityTab === tab.id ? 'bg-blue-brand text-white shadow-lg scale-105' : 'text-[#5D576B]/40 hover:text-blue-brand'}`}
                                        >
                                            {tab.label}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {communityTab === 'DEBATE' ? (
                            /* Ëæ©ËÆ∫Â≠òÊ°£Âç°Áâá */
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 animate-in">
                                {[1, 2, 3, 4].map(i => (
                                    <div key={i} className="bg-white p-8 rounded-[48px] border border-[#E8E6E0] shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer group">
                                        <div className="flex items-center gap-5 mb-6">
                                            <div className="w-12 h-12 rounded-2xl bg-[#FDFBF7] flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">üé≠</div>
                                            <div>
                                                <h4 className="font-bold text-lg text-[#1A1A1A]">Shared Reflection #{i}204</h4>
                                                <p className="text-[10px] uppercase font-bold text-blue-brand tracking-widest">3 Voices Engaging</p>
                                            </div>
                                        </div>
                                        <p className="text-sm italic opacity-60 leading-relaxed line-clamp-2">"Exploring the complex tension between the safety of the known and the fear of the unknown during graduation..."</p>
                                        <div className="mt-8 pt-6 border-t border-slate-50 flex justify-between items-center text-[10px] font-black uppercase tracking-widest opacity-30">
                                            <span>Reflected 2 days ago</span>
                                            <span className="group-hover:text-blue-brand transition-colors">Enter Archive ‚Üí</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            /* Á§æÂå∫ÂàÜ‰∫´ÁöÑ Persona Âç°Áâá */
                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 md:gap-8 animate-in">
                                {INITIAL_PERSONAS.map(p => (
                                    <div key={p.id} className="relative p-6 md:p-8 bg-white rounded-[40px] shadow-xl border-2 border-white/20 hover:scale-[1.03] transition-all flex flex-col aspect-[3/4] overflow-hidden cursor-pointer group">
                                        <div className="mb-6 flex items-center justify-center w-14 h-14 md:w-18 md:h-18 relative overflow-hidden group-hover:scale-110 transition-transform origin-center">
                                            <div className="absolute inset-0 bg-slate-50 rounded-[24px] transform rotate-6 scale-90 opacity-40 group-hover:bg-blue-brand/10 transition-colors" />
                                            <AvatarDisplay avatar={p.avatar} className="w-10 h-10 md:w-14 md:h-14 text-4xl md:text-5xl relative z-10" />
                                        </div>
                                        <div className="mt-auto text-left space-y-2">
                                            <h4 className="font-black text-xl md:text-2xl text-[#1A1A1A] tracking-tighter uppercase italic">{p.name}</h4>
                                            <p className="text-[7px] md:text-[8px] uppercase font-black tracking-widest text-blue-brand/80">COMMUNITY CREATION</p>
                                            <p className="text-[10px] md:text-xs italic opacity-40 leading-relaxed line-clamp-2">‚Äú{p.worldview}‚Äù</p>
                                        </div>
                                    </div>
                                ))}
                                <div className="relative p-6 bg-blue-brand/5 border-2 border-dashed border-blue-brand/30 rounded-[40px] flex flex-col items-center justify-center gap-4 aspect-[3/4]">
                                     <div className="w-12 h-12 rounded-full bg-white shadow-md flex items-center justify-center text-blue-brand"><Icon name="Plus" size={24} /></div>
                                     <p className="text-[10px] font-black uppercase tracking-[0.2em] opacity-40">Share Yours</p>
                                </div>
                            </div>
                        )}
                    </div>
                );
                
                if (view === 'builder') return <PersonaBuilder onSave={(newP) => { setPersonas([...personas, {...newP, id: `custom-${Date.now()}`, category: 'CUSTOM'}]); setView('persona-selection'); }} onCancel={() => setView('persona-selection')} />;
                
                if (view === 'persona-detail') return (
                    <div className="p-4 md:p-8 animate-in pb-20 overflow-y-auto no-scrollbar h-[calc(100vh-64px)]">
                        <div className="max-w-4xl mx-auto bg-white rounded-[40px] md:rounded-[60px] p-6 md:p-12 shadow-2xl border border-[#F0EDEA] relative overflow-hidden">
                            <div className="absolute top-0 right-0 w-32 h-32 bg-blue-brand/5 rounded-bl-full" />
                            <div className="flex justify-between mb-8 md:mb-16 relative z-10">
                                <button onClick={() => setView('persona-selection')} className="flex items-center gap-2 text-[10px] font-black uppercase tracking-widest opacity-40 hover:opacity-100 transition-all"><Icon name="ChevronLeft" size={14} /> Back</button>
                                <span className="text-[10px] uppercase font-bold opacity-30 tracking-[0.2em]">Archive ID: {detailPersona?.id.toUpperCase()}</span>
                            </div>
                            {/* ÁßªÂä®Á´ØÂ†ÜÂè†Â∏ÉÂ±Ä */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12 mb-12 md:mb-16">
                                <div className="bg-white p-4 shadow-lg border border-[#F0EDEA] rotate-[-2deg] rounded-2xl">
                                    <AvatarDisplay avatar={detailPersona?.avatar} className="aspect-[3/4] bg-slate-50 text-7xl md:text-9xl rounded-xl" />
                                </div>
                                <div className="flex flex-col justify-center space-y-4 md:space-y-6 text-center md:text-left">
                                    <h1 className="text-4xl md:text-6xl font-black text-[#1A1A1A] italic tracking-tighter uppercase leading-tight">{detailPersona?.name}</h1>
                                    <p className="text-xs md:text-sm font-bold text-blue-brand uppercase tracking-[0.4em]">{detailPersona?.role}</p>
                                    <div className="h-px w-20 bg-blue-brand/30 mx-auto md:mx-0" />
                                    <p className="text-lg md:text-xl italic opacity-70 leading-relaxed">‚Äú{detailPersona?.worldview}‚Äù</p>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8 mb-12 font-sans text-left">
                                <div className="md:col-span-2 p-6 md:p-10 bg-[#FDFBF7] border-2 border-dashed border-[#D1CEC7] rounded-3xl space-y-6">
                                    <h3 className="text-[10px] font-black uppercase tracking-widest opacity-30">Soul & Wisdom</h3>
                                    <p className="text-sm italic leading-relaxed">{detailPersona?.decisionStyle || "Grounded and reflective."}</p>
                                </div>
                                <div className="p-6 md:p-8 bg-white border border-[#F0EDEA] rounded-3xl shadow-sm">
                                    <h3 className="text-[10px] font-black uppercase tracking-widest opacity-30 mb-6">Voice</h3>
                                    <p className="text-xs md:text-sm italic text-neutral-600 border-l-2 border-blue-brand/20 pl-4">{detailPersona?.voice}</p>
                                </div>
                            </div>
                            <div className="flex flex-col md:flex-row justify-between items-center pt-8 border-t border-[#F0EDEA] gap-4">
                                <p className="text-[10px] italic opacity-40 uppercase tracking-widest text-center">Observation over noise.</p>
                                <button 
                                    onClick={() => { if(!selectedIds.includes(detailPersona?.id)) setSelectedIds([...selectedIds, detailPersona?.id]); setView('persona-selection'); }}
                                    className={`w-full md:w-auto px-10 py-4 rounded-full font-black uppercase tracking-widest text-[10px] transition-all shadow-xl ${selectedIds.includes(detailPersona?.id) ? 'bg-slate-200 text-slate-500' : 'bg-blue-brand text-white shadow-blue-brand/20'}`}
                                >
                                    {selectedIds.includes(detailPersona?.id) ? 'In Panel' : 'Invite to Debate'}
                                </button>
                            </div>
                        </div>
                    </div>
                );

                if (view === 'persona-selection') {
                    const filtered = category === 'ALL' ? personas : personas.filter(p => p.category === category);
                    return (
                        <div className="w-full flex flex-col items-center pt-8 md:pt-12 animate-in pb-32">
                            {/* ÂìçÂ∫îÂºèÂàÜÁ±ªÊ†è */}
                            <div className="flex justify-center mb-10 px-4 w-full overflow-x-auto no-scrollbar">
                                <div className="inline-flex bg-white/60 backdrop-blur-md p-1.5 rounded-full border-2 border-white shadow-lg whitespace-nowrap">
                                    {['ALL', 'CREATIVE', 'RATIONAL', 'SUPPORT', 'CUSTOM'].map(cat => (
                                        <button key={cat} onClick={() => setCategory(cat)} className={`px-4 md:px-8 py-2 md:py-3 rounded-full text-[9px] md:text-[10px] font-black uppercase tracking-[0.1em] md:tracking-[0.2em] transition-all duration-300 ${category === cat ? 'bg-blue-brand text-white shadow-lg scale-105' : 'text-[#5D576B]/40 hover:text-blue-brand'}`}>{cat}</button>
                                    ))}
                                </div>
                            </div>
                            <h2 className="text-3xl md:text-5xl font-serif italic mb-12 md:mb-20 text-[#5D576B] text-center tracking-tight px-4">Assemble the Voices</h2>
                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 md:gap-10 px-4 md:px-8 w-full max-w-[1250px]">
                                {filtered.map(p => (
                                    <div key={p.id} onClick={() => { setDetailPersona(p); setView('persona-detail'); }} className={`relative p-6 md:p-8 bg-white rounded-[40px] shadow-xl border-2 transition-all transform hover:scale-[1.03] flex flex-col aspect-[3/4] min-h-[300px] overflow-hidden group ${selectedIds.includes(p.id) ? 'border-blue-brand shadow-blue-brand/10' : 'border-white/20'}`}>
                                        <button onClick={(e) => toggleSelect(e, p)} className={`absolute top-6 right-6 w-10 h-10 rounded-full border-2 flex items-center justify-center z-30 transition-all ${selectedIds.includes(p.id) ? 'bg-blue-brand border-blue-brand shadow-lg scale-105' : 'bg-transparent border-slate-100 hover:border-blue-brand/40'}`}>
                                            {selectedIds.includes(p.id) && <Icon name="Check" size={18} className="text-white" />}
                                        </button>
                                        <div className="mb-6 flex items-center justify-center w-14 h-14 md:w-18 md:h-18 relative overflow-hidden group-hover:scale-110 transition-transform origin-center">
                                            <div className="absolute inset-0 bg-slate-50 rounded-[24px] transform rotate-6 scale-90 opacity-40 group-hover:bg-blue-brand/10 transition-colors" />
                                            <AvatarDisplay avatar={p.avatar} className="w-10 h-10 md:w-14 md:h-14 text-4xl md:text-5xl relative z-10" />
                                        </div>
                                        <div className="mt-auto text-left space-y-2">
                                            <h4 className="font-black text-xl md:text-2xl text-[#1A1A1A] tracking-tighter uppercase italic">{p.name}</h4>
                                            <p className="text-[7px] md:text-[8px] uppercase font-black tracking-widest text-blue-brand/80">{p.role}</p>
                                            <p className="text-[10px] md:text-xs italic opacity-40 leading-relaxed line-clamp-2">‚Äú{p.worldview}‚Äù</p>
                                        </div>
                                    </div>
                                ))}
                                <div onClick={() => setView('builder')} className="relative p-6 bg-white/30 backdrop-blur-sm rounded-[40px] border-2 border-dashed border-blue-brand/30 cursor-pointer transition-all hover:bg-white hover:border-blue-brand flex flex-col items-center justify-center gap-4 aspect-[3/4] min-h-[300px] text-center group">
                                    <div className="w-12 h-12 rounded-full bg-white shadow-lg flex items-center justify-center text-blue-brand group-hover:scale-110 transition-transform"><Icon name="Plus" size={24} /></div>
                                    <p className="text-[9px] md:text-[10px] font-black uppercase tracking-[0.2em] opacity-40 group-hover:opacity-80 transition-opacity">Create Voice</p>
                                </div>
                            </div>
                            {selectedIds.length >= 2 && (
                                <div className="fixed bottom-8 left-1/2 -translate-x-1/2 z-40 animate-in w-[90%] md:w-auto">
                                    <button onClick={() => setView('debate')} className="w-full md:w-auto px-12 md:px-16 py-5 md:py-6 bg-[#1A1A1A] text-white rounded-full font-black text-[10px] md:text-xs tracking-[0.3em] md:tracking-[0.4em] shadow-2xl hover:scale-105 transition-all uppercase">Commence Dialogue</button>
                                </div>
                            )}
                        </div>
                    );
                }

                if (view === 'debate') return <DebateArena context={context} selectedPersonas={personas.filter(p => selectedIds.includes(p.id))} setView={setView} />;

                if (view === 'summary') return (
                    <div className="text-center py-32 md:py-48 px-4 animate-in space-y-8 md:space-y-10 max-w-2xl mx-auto">
                        <div className="text-5xl md:text-7xl animate-bounce">üå±</div>
                        <h2 className="text-3xl md:text-5xl font-serif italic text-[#1A1A1A] tracking-tight">Pattern Observed</h2>
                        <button onClick={handleNewChat} className="px-12 md:px-16 py-5 md:py-6 bg-blue-brand text-white rounded-full font-black shadow-xl uppercase tracking-widest text-[9px] md:text-[10px] hover:shadow-2xl transition-all">Start New Chapter</button>
                    </div>
                );

                // Default Home
                return (
                    <section className="space-y-10 md:space-y-16 py-10 md:py-20 px-4 max-w-3xl mx-auto w-full animate-in flex flex-col items-center">
                        <header className="mb-6 md:mb-10 text-center space-y-3">
                            <h1 className="text-6xl md:text-8xl font-black tracking-tighter text-blue-brand uppercase italic leading-none">LIFEE</h1>
                            <p className="italic text-[8px] md:text-[10px] text-[#C1C1C1] uppercase tracking-[0.4em] md:tracking-[0.6em] font-black font-sans">YOUR LIFE & FRIEND COACH</p>
                        </header>
                        
                        <div className="w-full bg-white p-8 md:p-16 rounded-[40px] md:rounded-[70px] shadow-sm border border-[#F0EDEA] text-center relative overflow-hidden transition-all hover:shadow-xl">
                            <div className="absolute top-0 right-0 p-8 md:p-12 opacity-5"><Icon name="Sparkles" size={64} /></div>
                            <h2 className="text-xl md:text-3xl font-serif italic mb-6 md:mb-10 text-[#1A1A1A] tracking-tight">‚ÄúLet them argue, you decide.‚Äù</h2>
                            <textarea 
                                className="w-full h-40 md:h-52 p-6 md:p-8 bg-[#FDFBF7]/50 rounded-[30px] md:rounded-[40px] border-2 border-transparent focus-blue-brand transition-all duration-300 focus:outline-none text-base md:text-xl leading-relaxed placeholder:italic no-scrollbar" 
                                placeholder="Describe the current tension..." 
                                value={context.situation} 
                                onChange={(e) => setContext({...context, situation: e.target.value})} 
                            />
                        </div>

                        <div className="space-y-6 md:space-y-8 px-4 text-center w-full">
                            <h3 className="text-[10px] md:text-xs font-black uppercase tracking-[0.3em] text-blue-brand/50 uppercase">When is this landing?</h3>
                            <div className="flex flex-wrap justify-center gap-2 md:gap-3">
                                {PRESET_PERIODS.map(p => {
                                    const isSel = context.landingPeriods.includes(p);
                                    return (
                                        <button 
                                            key={p} 
                                            onClick={() => setContext(prev => ({...prev, landingPeriods: isSel ? prev.landingPeriods.filter(x => x !== p) : [...prev.landingPeriods, p]}))} 
                                            className={`px-4 md:px-8 py-2.5 md:py-3.5 rounded-full text-[9px] md:text-[11px] font-black transition-all border-2 uppercase tracking-widest ${isSel ? 'bg-blue-brand text-white border-blue-brand shadow-lg scale-105' : 'bg-white text-[#5D576B]/40 border-[#F0EDEA] hover:border-blue-brand/30 hover:text-blue-brand'}`}
                                        >
                                            {p}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                        <button 
                            disabled={!context.situation} 
                            onClick={() => setView('persona-selection')} 
                            className="w-full max-w-lg py-5 md:py-7 bg-blue-brand text-white rounded-full font-black shadow-2xl transition-all hover:translate-y-[-2px] uppercase tracking-[0.3em] text-[10px] md:text-xs disabled:opacity-10 active:scale-95"
                        >
                            Step Forward
                        </button>
                    </section>
                );
            };

            return (
                <AppLayout 
                    activeView={view} 
                    setView={setView} 
                    isLoggedIn={isLoggedIn} 
                    onLogin={() => setIsLoggedIn(true)}
                    onNewChat={handleNewChat}
                >
                    {renderContent()}
                </AppLayout>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>