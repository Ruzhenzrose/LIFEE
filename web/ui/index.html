<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFEE - Let Them Argue</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.43.4/dist/umd/supabase.js"></script>
    <script src="./data/navigation.js"></script>
    <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
    <script src="./help/view.js"></script>
    <script src="./my-chats/view.js"></script>
    <script src="./my-personas/view.js"></script>
    <script src="./settings/view.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Noto+Sans+SC:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #FDFBF7;
            color: #5D576B;
            margin: 0;
            overflow: hidden;
        }
        .font-serif {
            font-family: 'Noto Serif SC', serif;
        }
        .animate-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .focus-blue-brand:focus {
            outline: none;
            border-color: #98A6D4 !important;
            box-shadow: 0 0 0 3px rgba(152, 166, 212, 0.3);
        }

        .text-blue-brand { color: #98A6D4; }
        .bg-blue-brand { background-color: #98A6D4; }
        .border-blue-brand { border-color: #98A6D4; }

        /* Capsule toggle bar (SCENARIO / PROBLEM TYPE) */
        .capsule-container {
            background-color: #F1F3F4;
            padding: 5px;
            border-radius: 9999px;
            display: inline-flex;
            gap: 4px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .capsule-item {
            padding: 10px 36px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 900;
            letter-spacing: 0.2em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            white-space: nowrap;
        }
        .capsule-item-active {
            background-color: #98A6D4;
            color: white;
            box-shadow: 0 4px 12px rgba(152, 166, 212, 0.35);
        }
        .capsule-item-inactive {
            color: #5D576B;
            opacity: 0.5;
        }
        .capsule-item-inactive:hover {
            opacity: 1;
            background-color: rgba(255,255,255,0.6);
        }

        /* Landing category option button ‚Äî unselected: white bg, thin gray border, light gray text */
        .landing-opt {
            background-color: white;
            border: 1px solid #E8E6E0;
            color: #5D576B;
            opacity: 0.85;
            border-radius: 9999px;
            padding: 10px 20px;
            font-size: 10px;
            font-weight: 900;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            transition: all 0.25s ease;
        }
        .landing-opt:hover {
            border-color: #98A6D4;
            color: #98A6D4;
            opacity: 1;
        }
        .landing-opt.selected {
            background-color: #98A6D4;
            color: white;
            border-color: #98A6D4;
            box-shadow: 0 4px 12px rgba(152, 166, 212, 0.35);
            opacity: 1;
        }

        .sidebar-transition {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Suggested questions scrollbar style */
        .suggested-questions-scroll {
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 6px 0 14px 0;
            -webkit-overflow-scrolling: touch;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .suggested-questions-scroll::-webkit-scrollbar {
            display: none;
        }
        .suggested-questions-container {
            display: inline-flex;
            gap: 12px;
            padding: 0 4px;
            min-width: 100%;
        }
        .question-capsule {
            /* Tailwind preflight may set button background to transparent; use !important to ensure a solid button */
            background: #FFFFFF !important;
            background-color: #FFFFFF !important;
            border: 1px solid rgba(232, 230, 224, 0.85);
            border-radius: 9999px;
            padding: 12px 20px;
            white-space: nowrap;
            font-size: 13px;
            color: #5D576B;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            box-shadow: none;
        }
        .question-capsule:hover {
            border-color: #98A6D4;
            color: #98A6D4;
            background: #FFFFFF !important;
            background-color: #FFFFFF !important;
            box-shadow: none;
            transform: translateY(-1px);
        }
        @media (min-width: 768px) {
            .question-capsule {
                padding: 14px 24px;
                font-size: 14px;
            }
            .suggested-questions-container {
                gap: 16px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const copyToClipboard = async (text) => {
            try {
                if (navigator?.clipboard?.writeText) {
                    await navigator.clipboard.writeText(text);
                    return true;
                }
            } catch (_) {}
            try {
                const el = document.createElement('textarea');
                el.value = text;
                el.setAttribute('readonly', '');
                el.style.position = 'fixed';
                el.style.left = '-9999px';
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                return true;
            } catch (_) {
                return false;
            }
        };

        // --- Supabase ---
        const SUPABASE_URL = "https://ncoqeewtbmzrfizoxomi.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jb3FlZXd0Ym16cmZpem94b21pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwODc2OTMsImV4cCI6MjA4NTY2MzY5M30.rfG9Ei63zEi82hbwk6ulZ-tFrAHkuBht8HbSexPZb9g";
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const ADMIN_EMAIL = "hackathon@lifee.com";

        const SUMMARY_EVERY_DEFAULT = 15;
        const CONTEXT_WINDOW_DEFAULT = 15;

        const PRESET_PERIODS = [
            "First time studying abroad",
            "First year after graduation",
            "Early career confusion",
            "Career transition",
            "Around 30 ‚Äî feeling stuck",
            "Relationship turning point",
            "Creative burnout",
            "Major failure or loss",
            "Starting over in a new city",
            "Becoming independent"
        ];

        const LANDING_CATEGORIES = {
            scenario: [
                "First time studying abroad",
                "First year after graduation",
                "Career transition",
                "Relationship turning point",
                "Starting over in a new city",
                "Becoming independent"
            ],
            problemType: [
                "Early career confusion",
                "Around 30 ‚Äî feeling stuck",
                "Creative burnout",
                "Major failure or loss"
            ]
        };

        const INITIAL_PERSONAS = [
            {
                id: 'serene',
                name: 'SERENE',
                role: 'WARM COMFORTER',
                category: 'SUPPORT',
                worldview: "Gentleness isn't weakness ‚Äî it's the strength to hold the storm.",
                avatar: '‚ú®',
                decisionStyle: "Settle the feelings first, then choose: take small steps until life feels bearable again.",
                lifeContext: [
                    { period: "Learning to hold myself", detail: "In the low point, I learned not to deny what I feel: soothe first, then act." },
                    { period: "Warming the days", detail: "Repair and rebuild slowly through small, certain moments of comfort." }
                ],
                voice: "Let's slow down and give you a hug first. Then we'll break this into the first step you can do today."
            },
            {
                id: 'architect',
                name: 'The Entrepreneur',
                role: 'FOUNDER / OPERATOR',
                category: 'RATIONAL',
                worldview: "Pressure isn't the problem ‚Äî vagueness is. Break reality down and find the leverage.",
                avatar: 'üìê',
                decisionStyle: "Calm under pressure: name the key constraints and pursue the fastest feedback loop.",
                lifeContext: [
                    { period: "Operator Mode", detail: "Make decisions amid uncertainty: use data, cadence, and retrospectives to withstand pressure." }
                ],
                voice: "I'll be direct: you don't lack answers ‚Äî you lack a testable hypothesis and the next step. Let's make this real."
            },
            {
                id: 'rebel',
                name: 'The Outlier',
                role: 'DISRUPTIVE VOICE',
                category: 'RATIONAL',
                worldview: 'Status quo is the enemy of the soul.',
                avatar: 'üî•',
                voice: "If it doesn't hurt a little, you're probably lying to yourself."
            },
            {
                id: 'caretaker',
                name: 'The Positive Psychologist',
                role: 'POSITIVE PSYCHOLOGIST',
                category: 'SUPPORT',
                worldview: 'Warmth plus evidence turns confusion into direction.',
                avatar: 'üïØÔ∏è',
                voice: "First, steady the emotions; then look at the facts and options. You've been trying hard ‚Äî we can break the confusion into smaller, doable pieces."
            },
            {
                id: 'audrey-hepburn',
                name: 'AUDREY HEPBURN',
                role: 'ELEGANT MUSE',
                category: 'CREATIVE',
                worldview: "Elegance is the quiet courage to be kind, even when the world is loud.",
                avatar: 'üïäÔ∏è',
                cover_url: 'https://upload.wikimedia.org/wikipedia/commons/e/ed/My_Fair_Lady_Audrey_Hepburn.jpg',
                cover_fit: 'cover',
                cover_position: '50% 20%',
                decisionStyle: "Choose the simplest graceful option: protect your dignity, keep your promise, and make one small act of kindness that moves the story forward.",
                lifeContext: [
                    { period: "Carrying grace through hard years", detail: "Raised in Europe during WWII, she learned restraint, gratitude, and the art of standing tall without becoming hard." },
                    { period: "Roman Holiday (1953)", detail: "An unexpected breakthrough ‚Äî and an Academy Award for Best Actress. Sincerity over performance, softness as strength." },
                    { period: "Breakfast at Tiffany‚Äôs (1961)", detail: "A cultural icon of style and solitude: lightness on the surface, longing underneath." },
                    { period: "UNICEF Goodwill Ambassador (1988‚Äì1993)", detail: "Later in life she traveled relentlessly for children, turning fame into a tool for service rather than self." },
                    { period: "Presidential Medal of Freedom (1992)", detail: "Honored for humanitarian work ‚Äî proof that gentleness can also be public courage." }
                ],
                voice: "Darling, breathe. Ask: what would look simple and honest tomorrow morning? We'll choose the small step that keeps your heart gentle ‚Äî and your posture upright."
            },
            {
                id: 'krishnamurti',
                name: 'Krishnamurti',
                role: 'THE QUESTIONER',
                category: 'RATIONAL',
                worldview: 'Truth is a pathless land. No method can lead you there.',
                avatar: 'üåø',
                decisionStyle: "Never gives answers. Only questions. Points you back to look at the problem itself, not solutions.",
                lifeContext: [
                    { period: "The Dissolution", detail: "Dissolved the Order of the Star, rejecting the role of World Teacher that was prepared for him." },
                    { period: "Pathless Journey", detail: "Spent 60 years in dialogue, refusing to become an authority while speaking to millions." }
                ],
                voice: "Are you really asking, or seeking confirmation? Don't accept what I say ‚Äî look for yourself."
            },
            {
                id: 'lacan',
                name: 'Lacan',
                role: 'THE ANALYST',
                category: 'RATIONAL',
                worldview: 'Truth can only be half-said. The complete truth is impossible.',
                avatar: 'ü™û',
                decisionStyle: "Responds to questions with questions. No comfort, no advice. Cuts through certainty to let the unconscious speak.",
                lifeContext: [
                    { period: "Return to Freud", detail: "Revolutionized psychoanalysis by insisting: the unconscious is structured like a language." },
                    { period: "The Seminar", detail: "27 years of legendary seminars in Paris, notoriously difficult, deliberately so." }
                ],
                voice: "The unconscious is structured like a language. What slips out when you speak?"
            }
        ];

        // ‚úÖ LIFEE API (JSON: { messages: [...], options: [...] })
        const LIFEE_API = "https://lifee-api.guolinn.workers.dev/decision";

        async function fetchLifeeDecision(payload, url = LIFEE_API) {
            const res = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const text = await res.text();
                throw new Error("LIFEE API failed: " + text);
            }

            return res.json();
        }

        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        async function fetchText(url) {
            const res = await fetch(url, { method: 'GET' });
            if (!res.ok) throw new Error(`fetchText failed: ${res.status}`);
            return res.text();
        }

        async function fetchLifeeDecisionStream(payload, { onMessage, onOptions } = {}) {
            const res = await fetch(`${LIFEE_API}?stream=1`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const text = await res.text();
                throw new Error("LIFEE API stream failed: " + text);
            }

            if (!res.body) {
                throw new Error("Streaming not supported in this browser.");
            }

            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let buf = "";
            let done = false;

            const flushEventBlock = async (block) => {
                // Ignore comments
                if (!block || block.startsWith(":")) return;
                const lines = block.split("\n").filter(Boolean);
                let eventName = "message";
                const dataLines = [];
                for (const line of lines) {
                    if (line.startsWith("event:")) eventName = line.slice(6).trim();
                    else if (line.startsWith("data:")) dataLines.push(line.slice(5).trim());
                }
                const dataStr = dataLines.join("\n");
                if (!dataStr) return;

                let data = dataStr;
                try { data = JSON.parse(dataStr); } catch (_) {}

                if (eventName === "message") {
                    if (data && typeof data === "object") await onMessage?.(data);
                } else if (eventName === "options") {
                    const opts = (data && typeof data === "object") ? data.options : [];
                    onOptions?.(Array.isArray(opts) ? opts : []);
                } else if (eventName === "error") {
                    const errMsg = (data && typeof data === "object") ? (data.error || JSON.stringify(data)) : String(data);
                    throw new Error(errMsg);
                } else if (eventName === "done") {
                    done = true;
                }
            };

            while (!done) {
                const { value, done: streamDone } = await reader.read();
                if (streamDone) break;
                buf += decoder.decode(value, { stream: true });
                let idx;
                while ((idx = buf.indexOf("\n\n")) !== -1) {
                    const block = buf.slice(0, idx).trimEnd();
                    buf = buf.slice(idx + 2);
                    await flushEventBlock(block);
                }
            }
        }

        async function fetchLifeeDecisionProgressive(payload, { onMessage, onOptions } = {}) {
            // ÈªòËÆ§ÔºöÊåâ persona ÈÄê‰∏™ËØ∑Ê±ÇÔºåÂÖàÂá∫Á¨¨‰∏Ä‰∏™ËßíËâ≤ÁöÑÊ∂àÊÅØÔºåÂÜçÂá∫‰∏ã‰∏Ä‰∏™Ôºà‰ΩìÊÑüÊõ¥Âø´Ôºâ
            const personas = Array.isArray(payload?.personas) ? payload.personas : [];
            if (personas.length <= 1) {
                const data = await fetchLifeeDecision(payload);
                if (Array.isArray(data?.messages)) {
                    for (const m of data.messages) await onMessage?.(m);
                }
                if (Array.isArray(data?.options)) onOptions?.(data.options);
                else onOptions?.([]);
                return;
            }

            const earlier = [];
            let lastOptions = [];
            for (let i = 0; i < personas.length; i++) {
                const p = personas[i];
                const situationWithEarlier = earlier.length
                    ? `${(payload?.situation || "").trim()}\n\nEarlier voices:\n${earlier.map(m => `- ${m.personaId}: ${String(m.text || '').replace(/\n/g, ' ')}`).join('\n')}`
                    : payload?.situation;

                const singlePayload = { ...payload, situation: situationWithEarlier, personas: [p] };
                const data = await fetchLifeeDecision(singlePayload);
                if (Array.isArray(data?.messages)) {
                    for (const m of data.messages) {
                        earlier.push(m);
                        await onMessage?.(m);
                    }
                }
                if (Array.isArray(data?.options)) lastOptions = data.options;
                // Áªô React ‰∏ÄÊ¨°Ê∏≤ÊüìÊú∫‰ºöÔºåËÆ©‚ÄúÂÖàÂá∫Á¨¨‰∏Ä‰∏™ËßíËâ≤‚ÄùÊõ¥ÊòéÊòæ
                await sleep(0);
            }
            onOptions?.(lastOptions);
        }

        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                const lucide = window.lucide;
                if (!iconRef.current || !lucide) return;
                const fallbackMap = {
                    Pencil: 'PenLine',
                    Edit: 'PenLine',
                    Pen: 'PenLine'
                };
                const resolved = lucide[name] ? name : (fallbackMap[name] && lucide[fallbackMap[name]] ? fallbackMap[name] : null);
                if (!resolved) return;
                try {
                    // Ensure DOM attribute matches the icon we actually render (important for fallbacks).
                    iconRef.current.setAttribute('data-lucide', resolved);
                    lucide.createIcons({
                        icons: { [resolved]: lucide[resolved] },
                        attrs: { 'stroke-width': 2, 'width': size, 'height': size }
                    });
                } catch (e) {
                    // Avoid hard crash if an icon name is missing in current lucide build.
                    console.warn('lucide icon render failed:', resolved, e);
                }
            }, [name, size]);
            return <i data-lucide={name} className={className} ref={iconRef} style={{ width: size, height: size, display: 'inline-flex' }}></i>;
        };

        const AvatarDisplay = ({ avatar, className = "" }) => {
            const isImage = typeof avatar === 'string' && (avatar.startsWith('data:image') || avatar.startsWith('http'));
            return (
                <div className={`flex items-center justify-center overflow-hidden ${className}`}>
                    {isImage ? (
                        <img src={avatar} alt="Avatar" className="w-full h-full object-cover" />
                    ) : (
                        <span className="text-current leading-none">{avatar}</span>
                    )}
                </div>
            );
        };

        // --- User avatar (local, upload or random icon) ---
        const USER_AVATAR_KEY = 'lifee_user_avatar';
        const USER_AVATAR_DEFAULT_KEY = 'lifee_user_avatar_default';
        const USER_AVATAR_CHOICES = ['‚ú®', 'üåø', 'üî•', 'üïØÔ∏è', 'ü™û', 'ü¶â', 'üåä', 'üíé', 'üé≠', 'üõ°Ô∏è', 'üå±', '‚òÅÔ∏è'];

        const pickRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];

        const getOrCreateDefaultUserAvatar = () => {
            try {
                const existing = window.localStorage.getItem(USER_AVATAR_DEFAULT_KEY);
                if (existing) return existing;
                const next = pickRandom(USER_AVATAR_CHOICES);
                window.localStorage.setItem(USER_AVATAR_DEFAULT_KEY, next);
                return next;
            } catch (_) {
                return 'üë§';
            }
        };

        const loadUserAvatar = () => {
            try {
                return window.localStorage.getItem(USER_AVATAR_KEY) || getOrCreateDefaultUserAvatar();
            } catch (_) {
                return 'üë§';
            }
        };

        const saveUserAvatar = (avatar) => {
            try {
                if (avatar) window.localStorage.setItem(USER_AVATAR_KEY, avatar);
                else window.localStorage.removeItem(USER_AVATAR_KEY);
            } catch (_) {}
        };

        const rotateUserDefaultAvatar = () => {
            try {
                const next = pickRandom(USER_AVATAR_CHOICES);
                window.localStorage.setItem(USER_AVATAR_DEFAULT_KEY, next);
                return next;
            } catch (_) {
                return 'üë§';
            }
        };

        const fileToDataURL = (file) => new Promise((resolve, reject) => {
            try {
                const reader = new FileReader();
                reader.onload = () => resolve(String(reader.result || ''));
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            } catch (e) {
                reject(e);
            }
        });

        // --- Persona avatar overrides (local) ---
        const PERSONA_AVATAR_OVERRIDES_KEY = 'lifee_persona_avatar_overrides';
        const PERSONA_COVER_OVERRIDES_KEY = 'lifee_persona_cover_overrides';
        const DEFAULT_PERSONA_ICONS = ['‚ú®', 'üåø', 'üî•', 'üïØÔ∏è', 'ü™û', 'ü¶â', 'üåä', 'üíé', 'üé≠', 'üõ°Ô∏è', 'üå±', '‚òÅÔ∏è', 'üë§'];

        const loadPersonaAvatarOverrides = () => {
            try {
                const raw = window.localStorage.getItem(PERSONA_AVATAR_OVERRIDES_KEY);
                if (!raw) return {};
                const parsed = JSON.parse(raw);
                return (parsed && typeof parsed === 'object') ? parsed : {};
            } catch (_) {
                return {};
            }
        };

        const savePersonaAvatarOverrides = (map) => {
            try {
                window.localStorage.setItem(PERSONA_AVATAR_OVERRIDES_KEY, JSON.stringify(map || {}));
            } catch (_) {}
        };

        const loadPersonaCoverOverrides = () => {
            try {
                const raw = window.localStorage.getItem(PERSONA_COVER_OVERRIDES_KEY);
                if (!raw) return {};
                const parsed = JSON.parse(raw);
                return (parsed && typeof parsed === 'object') ? parsed : {};
            } catch (_) {
                return {};
            }
        };

        const savePersonaCoverOverrides = (map) => {
            try {
                window.localStorage.setItem(PERSONA_COVER_OVERRIDES_KEY, JSON.stringify(map || {}));
            } catch (_) {}
        };

        const PatternCover = ({ avatar }) => {
            const isImage = typeof avatar === 'string' && (avatar.startsWith('data:image') || avatar.startsWith('http'));
            return (
                <div className="absolute inset-0">
                    <div className="absolute inset-0 bg-gradient-to-br from-white via-[#FDFBF7] to-[#F3F1EC]" />
                    {isImage ? (
                        <>
                            <div className="absolute inset-0 opacity-[0.16]">
                                <img src={avatar} alt="cover motif" className="w-full h-full object-cover grayscale scale-110 blur-[2px]" loading="lazy" />
                            </div>
                            <div className="absolute inset-0 bg-white/50" />
                        </>
                    ) : (
                        <>
                            <div className="absolute -top-10 -left-8 text-[120px] opacity-[0.08] select-none">{avatar || 'üë§'}</div>
                            <div className="absolute -bottom-12 -right-8 text-[140px] opacity-[0.07] select-none">{avatar || 'üë§'}</div>
                            <div className="absolute inset-0 flex items-center justify-center">
                                <div className="w-20 h-20 rounded-[28px] bg-white/70 border border-white shadow-sm flex items-center justify-center">
                                    <AvatarDisplay avatar={avatar || 'üë§'} className="w-full h-full text-3xl opacity-60" />
                                </div>
                            </div>
                        </>
                    )}
                    <div className="absolute inset-0 bg-gradient-to-br from-white/60 via-transparent to-transparent pointer-events-none" />
                </div>
            );
        };

        const AuthModal = ({ isOpen, onClose, onAuthed }) => {
            const [mode, setMode] = useState('login');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');

            if (!isOpen) return null;

            const handleAuth = async () => {
                setLoading(true);
                setMessage('');
                try {
                    if (mode === 'login') {
                        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                        if (data?.user) onAuthed(data.user);
                    } else {
                        const { data, error } = await supabaseClient.auth.signUp({ email, password });
                        if (error) throw error;
                        if (data?.user) {
                            setMessage('Sign-up successful. Please verify your email, then sign in.');
                        }
                    }
                } catch (err) {
                    setMessage(err?.message || 'Operation failed. Please try again.');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center">
                    <div className="absolute inset-0 bg-black/30 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative w-full max-w-md bg-white rounded-[36px] shadow-2xl border border-[#F0EDEA] p-10 animate-in">
                        <div className="flex items-center justify-between mb-8">
                            <h2 className="text-xl font-serif italic text-[#1A1A1A]">{mode === 'login' ? 'Sign in' : 'Sign up'}</h2>
                            <button onClick={onClose} className="text-xs font-bold uppercase tracking-widest opacity-40 hover:opacity-100">
                                <Icon name="X" size={14} />
                            </button>
                        </div>
                        <div className="space-y-4">
                            <input type="email" placeholder="Email" className="w-full p-4 bg-[#FDFBF7] rounded-3xl border border-[#F0EDEA] transition-all focus-blue-brand" value={email} onChange={(e) => setEmail(e.target.value)} />
                            <input type="password" placeholder="Password" className="w-full p-4 bg-[#FDFBF7] rounded-3xl border border-[#F0EDEA] transition-all focus-blue-brand" value={password} onChange={(e) => setPassword(e.target.value)} />
                            {message && (
                                <div className="text-xs text-[#C97A7A] bg-[#FDF1F1] border border-[#F7D7D7] px-4 py-3 rounded-2xl">{message}</div>
                            )}
                            <button onClick={handleAuth} disabled={loading || !email || !password} className="w-full py-4 bg-blue-brand text-white rounded-full font-bold uppercase text-xs tracking-[0.2em] shadow-xl disabled:opacity-40">
                                {loading ? 'Working...' : (mode === 'login' ? 'Sign in' : 'Sign up')}
                            </button>
                            <button onClick={() => setMode(mode === 'login' ? 'signup' : 'login')} className="w-full text-xs uppercase tracking-[0.2em] opacity-50 hover:opacity-100">
                                {mode === 'login' ? "Don't have an account? Sign up" : 'Already have an account? Sign in'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ isOpen, onClose, personas, onRefresh }) => {
            const [selectedId, setSelectedId] = useState(personas?.[0]?.id || '');
            const [status, setStatus] = useState('');
            const [uploading, setUploading] = useState(false);

            useEffect(() => {
                if (personas?.length && !selectedId) {
                    setSelectedId(personas[0].id);
                }
            }, [personas, selectedId]);

            if (!isOpen) return null;

            const selected = personas.find(p => p.id === selectedId);

            const uploadAsset = async (file, type) => {
                if (!file || !selected) return;
                setUploading(true);
                setStatus('');
                try {
                    const ext = file.name.split('.').pop() || 'png';
                    const path = `personas/${selected.id}/${type}.${ext}`;
                    const { error: uploadError } = await supabaseClient.storage
                        .from('persona-assets')
                        .upload(path, file, { upsert: true });
                    if (uploadError) throw uploadError;

                    const { data: publicData } = supabaseClient.storage.from('persona-assets').getPublicUrl(path);
                    const url = publicData?.publicUrl || null;
                    if (!url) throw new Error('Unable to get public URL');

                    const payload = {
                        id: selected.id,
                        name: selected.name || selected.id
                    };
                    if (type === 'avatar') payload.avatar_url = url;
                    if (type === 'cover') payload.cover_url = url;

                    const { error: upsertError } = await supabaseClient.from('personas').upsert(payload, { onConflict: 'id' });
                    if (upsertError) throw upsertError;

                    setStatus('Upload succeeded');
                    await onRefresh?.();
                } catch (err) {
                    setStatus(err?.message || 'Upload failed');
                } finally {
                    setUploading(false);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center">
                    <div className="absolute inset-0 bg-black/30 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative w-full max-w-2xl bg-white rounded-[36px] shadow-2xl border border-[#F0EDEA] p-8 animate-in">
                        <div className="flex items-center justify-between mb-6">
                            <h2 className="text-xl font-serif italic text-[#1A1A1A]">Admin panel</h2>
                            <button onClick={onClose} className="text-xs font-bold uppercase tracking-widest opacity-40 hover:opacity-100">
                                <Icon name="X" size={14} />
                            </button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="space-y-3">
                                <div className="text-[10px] uppercase tracking-[0.2em] opacity-50">Select persona</div>
                                <select
                                    className="w-full p-3 rounded-2xl border border-[#F0EDEA] bg-[#FDFBF7] focus-blue-brand"
                                    value={selectedId}
                                    onChange={(e) => setSelectedId(e.target.value)}
                                >
                                    {personas.map(p => (
                                        <option key={p.id} value={p.id}>{p.name || p.id}</option>
                                    ))}
                                </select>
                                <div className="text-xs opacity-60">Current: {selected?.name || selected?.id || '-'}</div>
                            </div>
                            <div className="space-y-4">
                                <div className="flex items-center gap-4">
                                    <div className="w-16 h-16 rounded-2xl overflow-hidden border border-[#F0EDEA] bg-[#FDFBF7]">
                                        <AvatarDisplay avatar={selected?.avatar} className="w-full h-full text-3xl" />
                                    </div>
                                    <div className="text-xs opacity-60">Avatar preview</div>
                                </div>
                                <label className="block text-xs uppercase tracking-[0.2em] opacity-60">Upload avatar</label>
                                <input type="file" accept="image/*" disabled={uploading} onChange={(e) => uploadAsset(e.target.files?.[0], 'avatar')} />

                                <label className="block text-xs uppercase tracking-[0.2em] opacity-60 mt-4">Upload cover</label>
                                <input type="file" accept="image/*" disabled={uploading} onChange={(e) => uploadAsset(e.target.files?.[0], 'cover')} />

                                {status && <div className="text-xs text-blue-brand">{status}</div>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Settings components moved to `web/ui/settings/view.js`

        const PersonaEditModal = ({ isOpen, persona, onClose, onSave }) => {
            const [draft, setDraft] = useState(null);
            const emojis = ['üë§', 'üé≠', 'üõ°Ô∏è', 'üå±', 'ü¶â', 'üíé', 'üå©Ô∏è', 'üåä', 'üî•', 'üéÄ', 'üß∏', '‚òÅÔ∏è'];

            useEffect(() => {
                if (!isOpen || !persona) return;
                setDraft({
                    name: persona.name || '',
                    role: persona.role || '',
                    worldview: persona.worldview || '',
                    voice: persona.voice || '',
                    avatar: persona.avatar || 'üë§'
                });
            }, [isOpen, persona?.id]);

            if (!isOpen || !persona || !draft) return null;

            const save = () => {
                onSave?.({
                    ...persona,
                    name: draft.name,
                    role: draft.role,
                    worldview: draft.worldview,
                    voice: draft.voice,
                    avatar: draft.avatar
                });
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center">
                    <div className="absolute inset-0 bg-black/30 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative w-full max-w-2xl bg-white rounded-[36px] shadow-2xl border border-[#F0EDEA] p-8 md:p-10 animate-in">
                        <div className="flex items-center justify-between mb-6">
                            <h2 className="text-xl font-serif italic text-[#1A1A1A]">Edit Persona</h2>
                            <button onClick={onClose} className="text-xs font-bold uppercase tracking-widest opacity-40 hover:opacity-100">
                                <Icon name="X" size={14} />
                            </button>
                        </div>
                        <div className="space-y-5">
                            <input
                                placeholder="Name..."
                                className="w-full p-4 bg-[#FDFBF7] rounded-2xl border border-[#F0EDEA] focus-blue-brand"
                                value={draft.name}
                                onChange={(e) => setDraft({ ...draft, name: e.target.value })}
                            />
                            <input
                                placeholder="Role / Identity"
                                className="w-full p-4 bg-[#FDFBF7] rounded-2xl border border-[#F0EDEA] uppercase text-xs focus-blue-brand"
                                value={draft.role}
                                onChange={(e) => setDraft({ ...draft, role: e.target.value })}
                            />
                            <div className="flex flex-wrap gap-2 justify-center pt-1">
                                {emojis.map(e => (
                                    <button
                                        key={e}
                                        onClick={() => setDraft({ ...draft, avatar: e })}
                                        className={`p-3 rounded-xl transition-all border-2 ${draft.avatar === e ? 'border-blue-brand bg-white' : 'border-transparent bg-slate-50'}`}
                                    >
                                        {e}
                                    </button>
                                ))}
                            </div>
                            <textarea
                                placeholder="Worldview Statement..."
                                className="w-full h-28 p-5 bg-[#FDFBF7] rounded-2xl border border-[#F0EDEA] text-sm italic focus-blue-brand"
                                value={draft.worldview}
                                onChange={(e) => setDraft({ ...draft, worldview: e.target.value })}
                            />
                            <textarea
                                placeholder="Voice Sample..."
                                className="w-full h-24 p-5 bg-[#FDFBF7] rounded-2xl border border-[#F0EDEA] text-sm focus-blue-brand"
                                value={draft.voice}
                                onChange={(e) => setDraft({ ...draft, voice: e.target.value })}
                            />
                            <button
                                onClick={save}
                                disabled={!draft.name || !draft.role}
                                className="w-full py-4 bg-blue-brand text-white rounded-full font-bold uppercase text-xs tracking-[0.2em] shadow-xl disabled:opacity-40"
                            >
                                Save
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const PersonaIconEditorModal = ({ isOpen, persona, onClose, onSetAvatar, onUseDefault }) => {
            if (!isOpen || !persona) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center">
                    <div className="absolute inset-0 bg-black/30 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative w-full max-w-md bg-white rounded-[36px] shadow-2xl border border-[#F0EDEA] p-8 md:p-10 animate-in">
                        <div className="flex items-center justify-between mb-6">
                            <div className="text-[10px] font-black uppercase tracking-[0.25em] opacity-40">Icon Editor</div>
                            <button onClick={onClose} className="text-xs font-bold uppercase tracking-widest opacity-40 hover:opacity-100">
                                <Icon name="X" size={14} />
                            </button>
                        </div>
                        <div className="space-y-5">
                            <div className="flex items-center gap-3 justify-center">
                                <div className="w-14 h-14 rounded-2xl bg-[#FDFBF7] border border-[#F0EDEA] overflow-hidden">
                                    <AvatarDisplay avatar={persona?.avatar} className="w-full h-full text-2xl" />
                                </div>
                                <label className="cursor-pointer">
                                    <span className="px-4 h-10 inline-flex items-center rounded-full bg-blue-brand text-white text-[10px] font-black uppercase tracking-[0.2em] shadow-lg hover:shadow-xl transition-all">
                                        Upload icon
                                    </span>
                                    <input
                                        type="file"
                                        accept="image/*"
                                        className="hidden"
                                        onChange={async (e) => {
                                            const file = e.target.files?.[0];
                                            if (!file) return;
                                            try {
                                                const url = await fileToDataURL(file);
                                                onSetAvatar?.(url);
                                            } catch (err) {
                                                console.error(err);
                                            } finally {
                                                e.target.value = '';
                                            }
                                        }}
                                    />
                                </label>
                            </div>
                            <div className="flex flex-wrap gap-2 items-center justify-center">
                                {DEFAULT_PERSONA_ICONS.map(ic => (
                                    <button
                                        key={ic}
                                        type="button"
                                        onClick={() => onSetAvatar?.(ic)}
                                        className="w-10 h-10 rounded-2xl bg-white border border-[#E8E6E0] flex items-center justify-center text-xl hover:shadow-md transition-all"
                                        title="Choose a default icon"
                                    >
                                        {ic}
                                    </button>
                                ))}
                            </div>
                            <div className="flex flex-col sm:flex-row gap-3 pt-1">
                                <button
                                    type="button"
                                    onClick={onUseDefault}
                                    className="flex-1 px-4 h-11 rounded-full bg-[#FDFBF7] border border-[#E8E6E0] text-[10px] font-black uppercase tracking-[0.2em] hover:shadow-md transition-all"
                                >
                                    Use default
                                </button>
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 px-4 h-11 rounded-full bg-blue-brand text-white text-[10px] font-black uppercase tracking-[0.2em] shadow-lg hover:shadow-xl transition-all"
                                >
                                    Done
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AppLayout = ({ children, activeView, setView, user, isAdmin, onOpenAdmin, onLogin, onSignOut, onNewChat }) => {
            const [isCollapsed, setIsCollapsed] = useState(false);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const scrollContainerRef = useRef(null);

            const footerItems = (window.LIFEE_UI_NAV && Array.isArray(window.LIFEE_UI_NAV.footerItems))
                ? window.LIFEE_UI_NAV.footerItems
                : [
                    { id: 'my-chats', label: 'My Chats', icon: 'Archive', view: 'my-chats' },
                    { id: 'my-personas', label: 'My Personas', icon: 'Users', view: 'my-personas' },
                    { id: 'help', label: 'Help', icon: 'HelpCircle', view: 'help' },
                    { id: 'settings', label: 'Settings', icon: 'Settings', view: 'settings' }
                ];

            useEffect(() => {
                const el = scrollContainerRef.current;
                if (!el) return;
                el.scrollTo({ top: 0, left: 0, behavior: 'auto' });
                el.scrollTop = 0;
                requestAnimationFrame(() => {
                    if (!scrollContainerRef.current) return;
                    scrollContainerRef.current.scrollTo({ top: 0, left: 0, behavior: 'auto' });
                    scrollContainerRef.current.scrollTop = 0;
                });
            }, [activeView]);

            const handleMobileNewChat = () => {
                onNewChat();
                setIsMobileMenuOpen(false);
            };

            return (
                <div className="flex h-screen overflow-hidden bg-[#FDFBF7]">
                    {isMobileMenuOpen && <div className="fixed inset-0 bg-black/20 backdrop-blur-sm z-40 md:hidden" onClick={() => setIsMobileMenuOpen(false)} />}
                    <aside className={`sidebar-transition fixed inset-y-0 left-0 z-50 bg-[#F8F6F2] border-r border-[#E8E6E0] flex flex-col p-4 md:relative md:translate-x-0 ${isMobileMenuOpen ? 'translate-x-0 w-[280px]' : '-translate-x-full w-[280px] md:translate-x-0'} ${!isCollapsed ? 'md:w-[260px]' : 'md:w-[72px]'}`}>
                        <div className="flex-1 overflow-y-auto no-scrollbar flex flex-col">
                            <button onClick={() => setIsCollapsed(!isCollapsed)} className="p-3 mb-4 rounded-xl hover:bg-white/60 transition-all text-blue-brand self-start hidden md:block"><Icon name="Menu" size={20} /></button>
                            <button onClick={() => setIsMobileMenuOpen(false)} className="p-3 mb-4 rounded-xl hover:bg-white/60 text-blue-brand md:hidden self-end"><Icon name="X" size={20} /></button>
                            <button onClick={handleMobileNewChat} className={`flex items-center gap-3 bg-white border border-[#E8E6E0] rounded-2xl shadow-sm hover:shadow-md transition-all font-bold text-[#5D576B] ${isCollapsed ? 'md:p-3 md:justify-center mb-8' : 'px-6 py-4 mb-8 text-sm'}`}>
                                <Icon name="Plus" size={20} className="text-blue-brand" />
                                <span className={isCollapsed ? 'md:hidden' : 'block'}>New Chat</span>
                            </button>
                            <nav className="space-y-1">
                                <div className={`text-[10px] uppercase font-bold tracking-widest opacity-30 px-4 mb-2 ${isCollapsed ? 'md:hidden' : 'block'}`}>History</div>
                                <button className={`w-full text-left rounded-xl hover:bg-white/60 transition-colors flex items-center ${isCollapsed ? 'md:p-3 md:justify-center' : 'px-4 py-3 text-xs opacity-60 italic truncate'}`}>
                                    <Icon name="MessageSquare" size={14} className={isCollapsed ? "md:text-blue-brand" : "mr-2 opacity-40"} />
                                    <span className={isCollapsed ? 'md:hidden' : 'block'}>"Recent thoughts..."</span>
                                </button>
                            </nav>
                        </div>
                        <div className="pt-4 border-t border-[#E8E6E0] space-y-1">
                            {footerItems.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => { setView(item.view); setIsMobileMenuOpen(false); }}
                                    className={`w-full flex items-center font-bold hover:bg-white/60 rounded-xl transition-all ${isCollapsed ? 'p-3 justify-center' : 'gap-3 px-4 py-2.5 text-xs'} ${activeView === item.view ? 'text-blue-brand' : ''}`}
                                >
                                    <Icon name={item.icon} size={18} />
                                    <span className={isCollapsed ? 'md:hidden' : 'block'}>{item.label}</span>
                                </button>
                            ))}
                            {isAdmin && (
                                <button onClick={onOpenAdmin} className={`w-full flex items-center font-bold hover:bg-white/60 rounded-xl transition-all ${isCollapsed ? 'p-3 justify-center' : 'gap-3 px-4 py-2.5 text-xs'}`}>
                                    <Icon name="Shield" size={18} />
                                    <span className={isCollapsed ? 'md:hidden' : 'block'}>Admin</span>
                                </button>
                            )}
                        </div>
                    </aside>

                    <div className="flex-1 flex flex-col overflow-hidden relative">
                        <header className="h-16 flex items-center justify-between px-4 md:px-8 bg-[#FDFBF7]/80 backdrop-blur-md z-30 sticky top-0 border-b border-[#E8E6E0]/30">
                            <div className="flex items-center gap-3">
                                <button onClick={() => setIsMobileMenuOpen(true)} className="p-2 md:hidden text-blue-brand"><Icon name="Menu" size={24} /></button>
                                <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView('home')}><span className="font-serif italic font-black text-blue-brand tracking-tighter text-xl md:text-2xl">LIFEE</span></div>
                            </div>
                            <div className="flex items-center gap-3 md:gap-8">
                                <button onClick={() => setView('community')} className={`text-[9px] md:text-[10px] font-black uppercase tracking-[0.1em] md:tracking-[0.2em] transition-all hover:text-blue-brand ${activeView === 'community' ? 'text-blue-brand underline underline-offset-8 font-bold' : 'text-[#5D576B]/60'}`}>Community</button>
                                {user ? (
                                    <button onClick={onSignOut} className="w-8 h-8 md:w-9 md:h-9 rounded-full bg-blue-brand text-white border-2 border-white shadow-lg flex items-center justify-center"><Icon name="LogOut" size={14} /></button>
                                ) : (
                                    <button onClick={onLogin} className="px-4 py-1.5 md:px-8 md:py-2.5 bg-blue-brand text-white rounded-full text-[9px] md:text-[10px] font-black uppercase tracking-widest shadow-lg active:scale-95 transition-all hover:bg-[#8795c4]">Sign In</button>
                                )}
                            </div>
                        </header>
                        <main key={activeView} className="flex-1 overflow-y-auto no-scrollbar"><div className="w-full max-w-[1400px] mx-auto">{children}</div></main>
                    </div>
                </div>
            );
        };

        const PersonaBuilder = ({ onSave, onCancel }) => {
            const [step, setStep] = useState(1);
            const [newP, setNewP] = useState({ name: '', role: '', worldview: '', avatar: 'üë§', voice: '', knowledge: '' });
            const emojis = ['üë§', 'üé≠', 'üõ°Ô∏è', 'üå±', 'ü¶â', 'üíé', 'üå©Ô∏è', 'üåä', 'üî•', 'üéÄ', 'üß∏', '‚òÅÔ∏è'];
            return (
                <div className="max-w-2xl mx-auto w-full pt-8 md:pt-12 px-4 font-sans animate-in">
                    <div className="mb-8 flex items-center justify-between">
                        <button onClick={onCancel} className="text-[10px] font-bold uppercase tracking-widest opacity-40 flex items-center gap-2"><Icon name="X" size={14} /> Cancel</button>
                        <div className="flex gap-2">
                            {[1, 2, 3].map(s => <div key={s} className={`w-2.5 h-2.5 rounded-full ${s <= step ? 'bg-blue-brand shadow-[0_0_8px_rgba(152,166,212,0.4)]' : 'bg-slate-200'}`} />)}
                        </div>
                    </div>
                    <div className="bg-white p-6 md:p-12 rounded-[40px] md:rounded-[60px] shadow-sm border border-[#F0EDEA] space-y-8">
                        {step === 1 && (
                            <div className="space-y-6">
                                <h2 className="text-xl md:text-2xl font-serif italic text-center uppercase text-[#1A1A1A]">Step 1: Identity</h2>
                                <input placeholder="Name..." className="w-full p-4 bg-[#FDFBF7] rounded-2xl border border-[#F0EDEA] focus-blue-brand" value={newP.name} onChange={e => setNewP({...newP, name: e.target.value})} />
                                <input placeholder="Role / Identity" className="w-full p-4 bg-[#FDFBF7] rounded-2xl border border-[#F0EDEA] uppercase text-xs focus-blue-brand" value={newP.role} onChange={e => setNewP({...newP, role: e.target.value})} />
                                <div className="flex flex-wrap gap-2 justify-center pt-2">{emojis.map(e => <button key={e} onClick={() => setNewP({...newP, avatar: e})} className={`p-3 rounded-xl transition-all border-2 ${newP.avatar === e ? 'border-blue-brand bg-white' : 'border-transparent bg-slate-50'}`}>{e}</button>)}</div>
                            </div>
                        )}
                        {step === 2 && (
                            <div className="space-y-6">
                                <h2 className="text-xl md:text-2xl font-serif italic text-center uppercase">Step 2: Soul</h2>
                                <textarea placeholder="Worldview Statement..." className="w-full h-32 p-5 bg-[#FDFBF7] rounded-2xl border border-[#F0EDEA] text-sm italic focus-blue-brand" value={newP.worldview} onChange={e => setNewP({...newP, worldview: e.target.value})} />
                                <textarea placeholder="Voice Sample..." className="w-full h-24 p-5 bg-[#FDFBF7] rounded-2xl border border-[#F0EDEA] text-sm focus-blue-brand" value={newP.voice} onChange={e => setNewP({...newP, voice: e.target.value})} />
                            </div>
                        )}
                        <div className="flex gap-3">
                            {step > 1 && <button onClick={() => setStep(step-1)} className="flex-1 py-4 bg-slate-50 text-neutral-400 rounded-full font-bold text-xs uppercase border">Back</button>}
                            <button onClick={() => step < 2 ? setStep(step+1) : onSave(newP)} disabled={step === 1 ? (!newP.name || !newP.role) : !newP.worldview} className="flex-[2] py-4 bg-[#1A1A1A] text-white rounded-full font-bold text-xs uppercase shadow-xl disabled:opacity-20 transition-all">{step < 2 ? 'CONTINUE' : 'ARCHIVE VOICE'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const DebateArena = ({
            context,
            selectedPersonas,
            setView,
            ensureSession,
            persistMessage,
            buildContextBlock,
            userAvatar
        }) => {
            const [history, setHistory] = useState([]);
            const [options, setOptions] = useState([]);
            const [isDebating, setIsDebating] = useState(false);
            const [inputValue, setInputValue] = useState('');
            const scrollRef = useRef(null);
            const inputFieldRef = useRef(null);

            useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [history]);

            const runRound = async (userInput = null) => {
                setIsDebating(true);
                const cleanInput = (userInput ?? inputValue ?? "").toString().trim();

                if (cleanInput) {
                    setHistory(prev => [...prev, { personaId: "user", text: cleanInput }]);
                    await persistMessage('user', cleanInput);
                    setInputValue('');
                }

                try {
                    const contextBlock = buildContextBlock();
                    const situation = (context.situation || "").trim();
                    const finalSituation = contextBlock
                        ? `Context:\n${contextBlock}\n\nUser situation:\n${situation || "Start the internal debate."}`
                        : (situation || "Start the internal debate.");

                    const payload = {
                        situation: finalSituation,
                        userInput: cleanInput,
                        personas: selectedPersonas.map(p => ({ id: p.id, name: p.name, knowledge: p.knowledge || '' })),
                        context: contextBlock
                    };

                    const handlers = {
                        onMessage: async (msg) => {
                            setHistory(prev => [...prev, msg]);
                            const role = msg.personaId === 'system' ? 'system' : 'assistant';
                            await persistMessage(role, msg.text || '');
                        },
                        onOptions: (opts) => {
                            setOptions(Array.isArray(opts) ? opts : []);
                        }
                    };

                    // Prefer SSE streaming (single request, progressive persona outputs).
                    try {
                        await fetchLifeeDecisionStream(payload, handlers);
                    } catch (streamErr) {
                        console.warn('stream failed; fallback to progressive JSON calls', streamErr);
                        await fetchLifeeDecisionProgressive(payload, handlers);
                    }
                } catch (e) {
                    console.error(e);
                    setHistory(prev => [...prev, { personaId: "system", text: "(Request failed) Check API / CORS / response format" }]);
                    setOptions([]);
                } finally {
                    setIsDebating(false);
                }
            };

            const copyText = (text) => { copyToClipboard(text); };

            const quoteText = (text, name) => {
                const quote = `"${text}" ‚Äî ${name}\n\n`;
                setInputValue(prev => quote + prev);
                inputFieldRef.current?.focus();
            };

            useEffect(() => { if (history.length === 0) runRound("Start conversation."); }, []);

            return (
                <div className="h-[calc(100vh-64px)] flex flex-col overflow-hidden font-sans animate-in">
                    <div className="p-4 border-b border-[#F0EDEA] bg-white flex items-center justify-between z-10">
                        <div className="flex -space-x-2">{selectedPersonas.map(p => <div key={p.id} className="w-8 h-8 rounded-full border-2 border-white overflow-hidden shadow-sm"><AvatarDisplay avatar={p.avatar} className="w-full h-full text-xs" /></div>)}</div>
                        <button onClick={() => setView('summary')} className="flex items-center gap-2 text-xs font-bold text-[#E6C6C1] px-4 py-2 border border-[#E6C6C1] rounded-full hover:bg-[#E6C6C1] hover:text-white transition-all"><Icon name="PauseCircle" size={14} /> STOP & DECIDE</button>
                    </div>
                    <div ref={scrollRef} className="flex-1 overflow-y-auto p-4 md:p-8 space-y-10 pb-64 no-scrollbar">
                        {history.map((m, idx) => {
                            const isUser = m.personaId === 'user';
                            const p = isUser
                                ? { name: 'YOU', avatar: (userAvatar || loadUserAvatar()) }
                                : (selectedPersonas.find(x => x.id === m.personaId) || (m.personaId === "system" ? { name: "SYSTEM", avatar: "‚ö†Ô∏è" } : { name: 'Voice', avatar: '‚òÅÔ∏è' }));
                            return (
                                <div key={idx} className={`flex gap-4 md:gap-5 ${isUser ? 'flex-row-reverse' : 'items-start'} animate-in`}>
                                    <div className={`w-10 h-10 md:w-11 md:h-11 rounded-full border flex items-center justify-center shadow-sm shrink-0 bg-white overflow-hidden ${isUser ? 'border-blue-brand/30' : 'border-[#F0EDEA]'}`}><AvatarDisplay avatar={p.avatar} className="w-full h-full text-2xl" /></div>
                                    <div className={`max-w-[85%] md:max-w-[70%] flex flex-col ${isUser ? 'items-end' : 'items-start'}`}>
                                        <span className="text-[10px] font-black opacity-30 tracking-widest uppercase mb-1.5">{p.name}</span>
                                        <div className={`p-4 md:p-5 rounded-[24px] md:rounded-[28px] text-sm shadow-sm transition-all duration-300 leading-relaxed ${isUser ? 'bg-blue-brand text-white rounded-tr-none' : 'bg-white border border-[#F0EDEA] rounded-tl-none'}`}>{m.text}</div>
                                        <div className={`flex gap-4 mt-2 px-1 ${isUser ? 'flex-row-reverse' : 'flex-row'}`}>
                                            <button onClick={() => copyText(m.text)} className="flex items-center gap-1.5 text-[10px] font-bold text-blue-brand/60 hover:text-blue-brand transition-colors uppercase tracking-widest"><Icon name="Copy" size={12} /> Copy</button>
                                            <button onClick={() => quoteText(m.text, p.name)} className="flex items-center gap-1.5 text-[10px] font-bold text-blue-brand/60 hover:text-blue-brand transition-colors uppercase tracking-widest"><Icon name="Quote" size={12} /> Quote</button>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                        {isDebating && <div className="animate-pulse flex gap-4"><div className="w-10 h-10 bg-slate-200 rounded-full" /><div className="h-14 w-64 bg-white border rounded-3xl" /></div>}
                    </div>
                    <div className="p-4 md:p-8 bg-gradient-to-t from-[#FDFBF7] via-[#FDFBF7] to-transparent">
                        <div className="max-w-3xl mx-auto space-y-4">
                            {options.length > 0 && !isDebating && <div className="flex flex-wrap justify-center gap-2 mb-2 animate-in">{options.map((opt, i) => <button key={i} onClick={() => runRound(opt)} className="px-4 py-2 bg-white/90 border border-blue-brand/20 rounded-full text-xs font-bold hover:bg-blue-brand hover:text-white transition-all shadow-sm">{opt}</button>)}</div>}
                            <div className="flex gap-3">
                                <button disabled={isDebating} onClick={() => runRound(null)} className="hidden md:block flex-1 py-5 bg-blue-brand text-white rounded-full font-bold shadow-xl transition-all hover:translate-y-[-2px] disabled:opacity-50 uppercase tracking-widest text-xs">STAY SILENT</button>
                                <div className="relative flex-[3] group">
                                    <input ref={inputFieldRef} type="text" placeholder="..." disabled={isDebating} className="w-full h-14 bg-white rounded-full shadow-xl border-2 border-transparent focus:border-blue-brand transition-all duration-300 px-6 md:px-8 focus:outline-none text-sm" value={inputValue} onChange={(e) => setInputValue(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && inputValue) runRound(); }} />
                                    <div className="absolute inset-y-0 right-6 flex items-center pointer-events-none group-focus-within:opacity-0 transition-opacity"><Icon name="MessageCircle" size={22} className="text-blue-brand" /></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CommunityView = ({ communityTab, setCommunityTab, favoriteIds, onToggleFavorite }) => (
            <div className="p-6 md:p-12 max-w-[1200px] mx-auto animate-in space-y-12">
                <div className="flex flex-col items-center space-y-6">
                    <h2 className="text-3xl md:text-5xl font-serif italic tracking-tight text-center">Community Archives</h2>
                    <div className="flex justify-center px-4 w-full"><div className="inline-flex bg-white/60 backdrop-blur-md p-1.5 rounded-full border-2 border-white shadow-lg whitespace-nowrap">{['DEBATE', 'PERSONA'].map(tab => <button key={tab} onClick={() => setCommunityTab(tab)} className={`px-8 md:px-12 py-2.5 md:py-3 rounded-full text-[10px] font-black uppercase tracking-[0.2em] transition-all duration-300 ${communityTab === tab ? 'bg-blue-brand text-white shadow-lg scale-105' : 'text-[#5D576B]/40 hover:text-blue-brand'}`}>{tab}</button>)}</div></div>
                </div>
                {communityTab === 'DEBATE' ? (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 animate-in">{[1, 2, 3, 4].map(i => <div key={i} className="bg-white p-8 rounded-[48px] border border-[#E8E6E0] shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer group"><div className="flex items-center gap-5 mb-6"><div className="w-12 h-12 rounded-2xl bg-[#FDFBF7] flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">üé≠</div><div><h4 className="font-bold text-lg text-[#1A1A1A]">Shared Reflection #{i}204</h4><p className="text-[10px] uppercase font-bold text-blue-brand tracking-widest">3 Voices Engaging</p></div></div><p className="text-sm italic opacity-60 leading-relaxed line-clamp-2">"Exploring the complex tension between the safety of the known and the fear of the unknown during graduation..."</p><div className="mt-8 pt-6 border-t border-slate-50 flex justify-between items-center text-[10px] font-black uppercase tracking-widest opacity-30"><span>Reflected 2 days ago</span><span className="group-hover:text-blue-brand transition-colors">Enter Archive ‚Üí</span></div></div>)}</div>
                ) : (
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 md:gap-8 animate-in">
                        {INITIAL_PERSONAS.map(p => {
                            const isFav = favoriteIds?.includes(p.id);
                            return (
                                <div key={p.id} className="relative p-6 md:p-8 bg-white rounded-[40px] shadow-xl border-2 border-white/20 hover:scale-[1.03] transition-all flex flex-col aspect-[3/4] overflow-hidden group">
                                    <button
                                        onClick={(e) => { e.stopPropagation(); onToggleFavorite?.(p); }}
                                        className={`absolute top-5 right-5 w-9 h-9 rounded-full border flex items-center justify-center z-20 transition-all ${isFav ? 'bg-blue-brand text-white border-blue-brand' : 'bg-white border-[#E8E6E0] text-[#5D576B]/40 hover:text-blue-brand'}`}
                                        title={isFav ? 'Remove from favorites' : 'Add to My Personas'}
                                    >
                                        <Icon name="Star" size={16} />
                                    </button>
                                    <div className="mb-6 flex items-center justify-center w-14 h-14 md:w-18 md:h-18 relative overflow-hidden group-hover:scale-110 transition-transform origin-center">
                                        <div className="absolute inset-0 bg-slate-50 rounded-[24px] transform rotate-6 scale-90 opacity-40 group-hover:bg-blue-brand/10 transition-colors" />
                                        <AvatarDisplay avatar={p.avatar} className="w-10 h-10 md:w-14 md:h-14 text-4xl md:text-5xl relative z-10" />
                                    </div>
                                    <div className="mt-auto text-left space-y-2">
                                        <h4 className="font-black text-xl md:text-2xl text-[#1A1A1A] tracking-tighter uppercase italic">{p.name}</h4>
                                        <p className="text-[7px] md:text-[8px] uppercase font-black tracking-widest text-blue-brand/80">COMMUNITY CREATION</p>
                                        <p className="text-[10px] md:text-xs italic opacity-40 leading-relaxed line-clamp-2">‚Äú{p.worldview}‚Äù</p>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}
            </div>
        );

        function App() {
            const [view, setView] = useState('home');
            const [context, setContext] = useState({ situation: '', landingPeriods: [] });
            const [landingTab, setLandingTab] = useState('scenario');
            const [personas, setPersonas] = useState(INITIAL_PERSONAS);
            const [personaKnowledge, setPersonaKnowledge] = useState({});
            const [selectedIds, setSelectedIds] = useState([]);
            const [detailPersona, setDetailPersona] = useState(null);
            const [category, setCategory] = useState('ALL');
            const [communityTab, setCommunityTab] = useState('DEBATE');
            const [user, setUser] = useState(null);
            const [authOpen, setAuthOpen] = useState(false);
            const [userAvatar, setUserAvatar] = useState(() => loadUserAvatar());
            const [sessionId, setSessionId] = useState(null);
            const [sessionMessages, setSessionMessages] = useState([]);
            const [sessionSummaries, setSessionSummaries] = useState([]);
            const [summaryEvery, setSummaryEvery] = useState(SUMMARY_EVERY_DEFAULT);
            const [contextWindow, setContextWindow] = useState(CONTEXT_WINDOW_DEFAULT);
            const [personaAssets, setPersonaAssets] = useState({});
            const [personaAvatarOverrides, setPersonaAvatarOverrides] = useState(() => loadPersonaAvatarOverrides());
            const [personaCoverOverrides, setPersonaCoverOverrides] = useState(() => loadPersonaCoverOverrides());
            const [adminOpen, setAdminOpen] = useState(false);
            const [chatSessions, setChatSessions] = useState([]);
            const [chatSessionsLoading, setChatSessionsLoading] = useState(false);
            const [chatDetailSession, setChatDetailSession] = useState(null);
            const [chatDetailMessages, setChatDetailMessages] = useState([]);
            const [chatDetailSummaries, setChatDetailSummaries] = useState([]);
            const [chatStatus, setChatStatus] = useState('');
            const [favoritePersonas, setFavoritePersonas] = useState([]);
            const [editPersona, setEditPersona] = useState(null);
            const [personaIconEditorOpen, setPersonaIconEditorOpen] = useState(false);

            const sessionMessagesRef = useRef([]);

            useEffect(() => {
                sessionMessagesRef.current = sessionMessages;
            }, [sessionMessages]);

            useEffect(() => {
                // Load persona-specific knowledge notes (optional).
                // Kept in UI folder so static hosting can serve it.
                let cancelled = false;
                (async () => {
                    try {
                        const txt = await fetchText('./my-personas/audrey-hepburn.md');
                        if (cancelled) return;
                        const clipped = (txt || '').trim().slice(0, 12000);
                        if (clipped) setPersonaKnowledge(prev => ({ ...(prev || {}), 'audrey-hepburn': clipped }));
                    } catch (e) {
                        console.warn('persona knowledge load failed', e);
                    }
                })();
                return () => { cancelled = true; };
            }, []);

            useEffect(() => {
                if (view !== 'persona-detail' && personaIconEditorOpen) setPersonaIconEditorOpen(false);
            }, [view, personaIconEditorOpen]);

            useEffect(() => {
                let mounted = true;
                const init = async () => {
                    const { data } = await supabaseClient.auth.getSession();
                    if (mounted) setUser(data?.session?.user || null);
                };
                init();
                const { data: sub } = supabaseClient.auth.onAuthStateChange((_event, session) => {
                    setUser(session?.user || null);
                });
                return () => {
                    mounted = false;
                    sub?.subscription?.unsubscribe?.();
                };
            }, []);

            useEffect(() => {
                try {
                    const raw = window.localStorage.getItem('lifee_favorite_personas');
                    if (raw) setFavoritePersonas(JSON.parse(raw));
                } catch (_) {}
            }, []);

            useEffect(() => {
                try {
                    window.localStorage.setItem('lifee_favorite_personas', JSON.stringify(favoritePersonas || []));
                } catch (_) {}
            }, [favoritePersonas]);

            useEffect(() => {
                savePersonaAvatarOverrides(personaAvatarOverrides || {});
            }, [personaAvatarOverrides]);

            useEffect(() => {
                savePersonaCoverOverrides(personaCoverOverrides || {});
            }, [personaCoverOverrides]);

            useEffect(() => {
                if (!user) return;
                const ensureProfileAndSettings = async () => {
                    await supabaseClient.from('profiles').upsert({
                        id: user.id,
                        email: user.email,
                        display_name: user.user_metadata?.name || null,
                        avatar_url: user.user_metadata?.avatar_url || null
                    }, { onConflict: 'id' });

                    const { data: settings } = await supabaseClient.from('user_settings').select('summary_every, context_window').eq('id', user.id).maybeSingle();
                    if (!settings) {
                        await supabaseClient.from('user_settings').insert({
                            id: user.id,
                            summary_every: SUMMARY_EVERY_DEFAULT,
                            context_window: CONTEXT_WINDOW_DEFAULT
                        });
                        setSummaryEvery(SUMMARY_EVERY_DEFAULT);
                        setContextWindow(CONTEXT_WINDOW_DEFAULT);
                    } else {
                        setSummaryEvery(settings.summary_every || SUMMARY_EVERY_DEFAULT);
                        setContextWindow(settings.context_window || CONTEXT_WINDOW_DEFAULT);
                    }
                };
                ensureProfileAndSettings();
            }, [user]);

            useEffect(() => {
                if (!user) return;
                const loadPersonaAssets = async () => {
                    const { data } = await supabaseClient.from('personas').select('id, avatar_url, cover_url');
                    const map = {};
                    (data || []).forEach(row => { map[row.id] = row; });
                    setPersonaAssets(map);
                };
                loadPersonaAssets();

                const loadChatSessions = async () => {
                    setChatSessionsLoading(true);
                    const { data } = await supabaseClient
                        .from('chat_sessions')
                        .select('id, title, updated_at, latest_message_at')
                        .eq('user_id', user.id)
                        .order('updated_at', { ascending: false });
                    setChatSessions(data || []);
                    setChatSessionsLoading(false);
                };
                loadChatSessions();

                const loadLatestSession = async () => {
                    const { data: sessions } = await supabaseClient
                        .from('chat_sessions')
                        .select('id, title, updated_at')
                        .eq('user_id', user.id)
                        .order('updated_at', { ascending: false })
                        .limit(1);

                    const latest = sessions?.[0];
                    if (!latest) return;

                    setSessionId(latest.id);
                    const { data: msgs } = await supabaseClient
                        .from('chat_messages')
                        .select('id, role, content, seq, created_at')
                        .eq('session_id', latest.id)
                        .order('seq', { ascending: true })
                        .limit(200);
                    setSessionMessages((msgs || []).map(m => ({ role: m.role, text: m.content, seq: m.seq })));

                    const { data: sums } = await supabaseClient
                        .from('chat_summaries')
                        .select('summary, start_seq, end_seq, created_at')
                        .eq('session_id', latest.id)
                        .order('created_at', { ascending: true });
                    setSessionSummaries(sums || []);
                };
                loadLatestSession();
            }, [user]);

            const buildRoughSummary = (messages) => {
                const lines = messages.map(m => `${m.role.toUpperCase()}: ${m.text}`);
                const joined = lines.join('\n');
                if (joined.length <= 1200) return joined;
                return joined.slice(0, 1200) + '‚Ä¶';
            };

            const buildShareTextFromSession = (title, messages, summaries) => {
                const summaryBlock = (summaries || []).length
                    ? summaries.map(s => `Summary(${s.start_seq || '-'}-${s.end_seq || '-'})\n${s.summary}`).join('\n\n')
                    : '';
                const msgBlock = (messages || []).map(m => `${(m.role || '').toUpperCase()}: ${m.text || ''}`).join('\n');
                return [
                    `LIFEE Chat Export`,
                    `Title: ${title || 'New Chat'}`,
                    `Date: ${new Date().toISOString()}`,
                    ``,
                    summaryBlock ? `---\n${summaryBlock}\n---\n` : '',
                    msgBlock ? msgBlock : '(no messages yet)'
                ].filter(Boolean).join('\n');
            };

            const buildContextBlock = () => {
                const summaryBlock = sessionSummaries.length
                    ? sessionSummaries.map(s => `Summary(${s.start_seq || '-'}-${s.end_seq || '-'})\n${s.summary}`).join('\n\n')
                    : '';
                const latestMsgs = sessionMessages.slice(-contextWindow).map(m => `${m.role.toUpperCase()}: ${m.text}`).join('\n');
                return [summaryBlock, latestMsgs].filter(Boolean).join('\n\n');
            };

            const ensureSession = async () => {
                if (sessionId) return sessionId;
                const { data, error } = await supabaseClient.from('chat_sessions').insert({
                    user_id: user.id,
                    title: 'New Chat'
                }).select('id').single();
                if (error) return null;
                setSessionId(data.id);
                setSessionMessages([]);
                setSessionSummaries([]);
                return data.id;
            };

            const persistMessage = async (role, text) => {
                if (!user) return;
                const activeSessionId = await ensureSession();
                if (!activeSessionId) return;

                const nextSeq = (sessionMessagesRef.current?.length || 0) + 1;
                const newMsg = { role, text, seq: nextSeq };
                const nextMessages = [...sessionMessagesRef.current, newMsg];
                setSessionMessages(nextMessages);

                await supabaseClient.from('chat_messages').insert({
                    session_id: activeSessionId,
                    user_id: user.id,
                    role,
                    content: text,
                    seq: nextSeq
                });

                await supabaseClient.from('chat_sessions').update({
                    updated_at: new Date().toISOString(),
                    latest_message_at: new Date().toISOString()
                }).eq('id', activeSessionId);

                if (nextMessages.length % summaryEvery === 0) {
                    const batch = nextMessages.slice(-summaryEvery);
                    const summaryText = buildRoughSummary(batch);
                    const startSeq = nextMessages.length - summaryEvery + 1;
                    const endSeq = nextMessages.length;

                    const summaryRow = {
                        session_id: activeSessionId,
                        user_id: user.id,
                        summary: summaryText,
                        start_seq: startSeq,
                        end_seq: endSeq
                    };

                    await supabaseClient.from('chat_summaries').insert(summaryRow);
                    setSessionSummaries(prev => [...prev, summaryRow]);
                }
            };

            const handleNewChat = async () => {
                if (!user) return;
                const { data } = await supabaseClient.from('chat_sessions').insert({
                    user_id: user.id,
                    title: 'New Chat'
                }).select('id').single();
                setSessionId(data?.id || null);
                setSessionMessages([]);
                setSessionSummaries([]);
                setContext({ situation: '', landingPeriods: [] });
                setSelectedIds([]);
                setView('home');
                await refreshChatSessions();
            };

            const toggleSelect = (e, p) => { e.stopPropagation(); setSelectedIds(prev => prev.includes(p.id) ? prev.filter(id => id !== p.id) : [...prev, p.id]); };

            const isAdmin = user?.email === ADMIN_EMAIL;
            const displayPersonas = personas.map(p => {
                const asset = personaAssets[p.id];
                const override = personaAvatarOverrides?.[p.id];
                const nextAvatar = override || asset?.avatar_url || p.avatar;
                const nextCover = personaCoverOverrides?.[p.id] || asset?.cover_url || p.cover_url || null;
                const knowledge = personaKnowledge?.[p.id] || p.knowledge || '';
                return { ...p, avatar: nextAvatar, cover_url: nextCover, knowledge };
            });

            const refreshChatSessions = async () => {
                if (!user) return;
                setChatSessionsLoading(true);
                const { data } = await supabaseClient
                    .from('chat_sessions')
                    .select('id, title, updated_at, latest_message_at')
                    .eq('user_id', user.id)
                    .order('updated_at', { ascending: false });
                setChatSessions(data || []);
                setChatSessionsLoading(false);
            };

            const loadSessionDetail = async (sessionRow) => {
                if (!user || !sessionRow?.id) return;
                setChatStatus('');
                setChatDetailSession(sessionRow);
                const { data: msgs } = await supabaseClient
                    .from('chat_messages')
                    .select('id, role, content, seq, created_at')
                    .eq('session_id', sessionRow.id)
                    .order('seq', { ascending: true })
                    .limit(300);
                setChatDetailMessages((msgs || []).map(m => ({ role: m.role, text: m.content, seq: m.seq })));

                const { data: sums } = await supabaseClient
                    .from('chat_summaries')
                    .select('summary, start_seq, end_seq, created_at')
                    .eq('session_id', sessionRow.id)
                    .order('created_at', { ascending: true });
                setChatDetailSummaries(sums || []);
            };

            const deleteSession = async (sessionRow) => {
                if (!sessionRow?.id) return;
                if (!window.confirm('Delete this chat? This cannot be undone.')) return;
                setChatStatus('');
                await supabaseClient.from('chat_messages').delete().eq('session_id', sessionRow.id);
                await supabaseClient.from('chat_summaries').delete().eq('session_id', sessionRow.id);
                await supabaseClient.from('chat_sessions').delete().eq('id', sessionRow.id);
                if (chatDetailSession?.id === sessionRow.id) {
                    setChatDetailSession(null);
                    setChatDetailMessages([]);
                    setChatDetailSummaries([]);
                }
                await refreshChatSessions();
                setChatStatus('Deleted');
            };

            const uploadChatToCommunity = async (sessionRow, messages, summaries) => {
                if (!user || !sessionRow?.id) return;
                setChatStatus('');
                const content = buildShareTextFromSession(sessionRow.title, messages, summaries);
                const payload = {
                    user_id: user.id,
                    session_id: sessionRow.id,
                    title: sessionRow.title || 'New Chat',
                    content,
                    created_at: new Date().toISOString()
                };
                const { error } = await supabaseClient.from('community_chats').insert(payload);
                if (error) {
                    setChatStatus(error.message || 'Upload failed');
                } else {
                    setChatStatus('Uploaded to community');
                }
            };

            const uploadPersonaToCommunity = async (persona) => {
                if (!user || !persona?.id) return;
                setChatStatus('');
                const payload = {
                    user_id: user.id,
                    persona_id: persona.id,
                    name: persona.name,
                    role: persona.role,
                    avatar: persona.avatar,
                    payload: persona,
                    created_at: new Date().toISOString()
                };
                const { error } = await supabaseClient.from('community_personas').insert(payload);
                if (error) {
                    setChatStatus(error.message || 'Upload failed');
                } else {
                    setChatStatus('Persona uploaded to community');
                }
            };

            const toggleFavoritePersona = (persona) => {
                if (!persona?.id) return;
                setFavoritePersonas(prev => {
                    const exists = prev?.some(p => p.id === persona.id);
                    if (exists) return prev.filter(p => p.id !== persona.id);
                    return [...(prev || []), persona];
                });
            };

            const renderContent = () => {
                if (view === 'community') return (
                    <CommunityView
                        communityTab={communityTab}
                        setCommunityTab={setCommunityTab}
                        favoriteIds={(favoritePersonas || []).map(p => p.id)}
                        onToggleFavorite={toggleFavoritePersona}
                    />
                );
                if (view === 'help') {
                    return window.LIFEE_VIEWS?.help?.({ onBack: () => setView('home') }) || null;
                }
                if (view === 'my-chats') {
                    return window.LIFEE_VIEWS?.myChats?.({
                        onBack: () => setView('home'),
                        refreshChatSessions,
                        chatSessionsLoading,
                        chatSessions,
                        chatDetailSession,
                        loadSessionDetail,
                        deleteSession,
                        uploadChatToCommunity,
                        chatDetailMessages,
                        chatDetailSummaries,
                        buildShareTextFromSession,
                        copyToClipboard,
                        setChatStatus,
                        chatStatus
                    }) || null;
                }
                if (view === 'my-personas') {
                    return window.LIFEE_VIEWS?.myPersonas?.({
                        onBack: () => setView('home'),
                        displayPersonas,
                        favoritePersonas,
                        setEditPersona,
                        uploadPersonaToCommunity,
                        toggleFavoritePersona,
                        goToCommunity: () => { setCommunityTab('PERSONA'); setView('community'); },
                        onNewPersona: () => setView('builder'),
                        chatStatus
                    }) || null;
                }
                if (view === 'settings') {
                    const lastMsgs = sessionMessages.slice(-40);
                    const summaryBlock = sessionSummaries.length
                        ? sessionSummaries.slice(-3).map(s => `Summary(${s.start_seq || '-'}-${s.end_seq || '-'})\n${s.summary}`).join('\n\n')
                        : '';
                    const msgBlock = lastMsgs.map(m => `${(m.role || '').toUpperCase()}: ${m.text || ''}`).join('\n');
                    const shareText = [
                        `LIFEE Chat Export`,
                        `Date: ${new Date().toISOString()}`,
                        ``,
                        `Situation:`,
                        (context?.situation || '').trim() || '(empty)',
                        ``,
                        `Landing:`,
                        (context?.landingPeriods || []).join(', ') || '(empty)',
                        ``,
                        summaryBlock ? `---\n${summaryBlock}\n---\n` : '',
                        msgBlock ? msgBlock : '(no messages yet)'
                    ].filter(Boolean).join('\n');

                    return window.LIFEE_VIEWS?.settings?.({
                        user,
                        isAdmin,
                        onOpenAdmin: () => setAdminOpen(true),
                        onSignOut: async () => { await supabaseClient.auth.signOut(); setUser(null); },
                        onBack: () => setView('home'),
                        onOpenPersona: () => setView('persona-selection'),
                        onOpenCommunityPersona: () => { setCommunityTab('PERSONA'); setView('community'); },
                        shareText,
                        userAvatar,
                        onUserAvatarChange: (a) => setUserAvatar(a || loadUserAvatar())
                    }) || null;
                }
                if (view === 'builder') return <PersonaBuilder onSave={(newP) => { setPersonas([...personas, {...newP, id: `custom-${Date.now()}`, category: 'CUSTOM'}]); setView('persona-selection'); }} onCancel={() => setView('persona-selection')} />;
                if (view === 'persona-detail') {
                    const cover = detailPersona?.cover_url || null;
                    const hasCover = !!(cover && typeof cover === 'string');
                    const coverFit = (detailPersona?.cover_fit || 'cover');
                    const coverPosition = (detailPersona?.cover_position || 'center');
                    return (
                        <div className="p-4 md:p-8 animate-in pb-20 overflow-y-auto no-scrollbar h-[calc(100vh-64px)]">
                            <div className={`max-w-5xl mx-auto ${hasCover ? 'bg-transparent' : 'bg-white'} rounded-[40px] md:rounded-[60px] p-6 md:p-12 shadow-2xl border border-[#F0EDEA] relative overflow-hidden`}>
                                {hasCover && (
                                    <div className="absolute inset-0">
                                        <img
                                            src={cover}
                                            alt="persona cover"
                                            className={`w-full h-full grayscale ${coverFit === 'cover' ? 'scale-105' : ''}`}
                                            style={{ objectFit: coverFit, objectPosition: coverPosition }}
                                            loading="lazy"
                                        />
                                        <div className="absolute inset-0 bg-white/80" />
                                    </div>
                                )}
                                <div className="absolute top-0 right-0 w-32 h-32 bg-blue-brand/5 rounded-bl-full" />
                                <div className="flex justify-between mb-8 md:mb-16 relative z-10"><button onClick={() => setView('persona-selection')} className="flex items-center gap-2 text-[10px] font-black uppercase tracking-widest opacity-40 hover:opacity-100 transition-all"><Icon name="ChevronLeft" size={14} /> Back</button><span className="text-[10px] uppercase font-bold opacity-30 tracking-[0.3em]">Archive ID: {detailPersona?.id.toUpperCase()}</span></div>
                                <div className="grid grid-cols-1 md:grid-cols-[360px_minmax(0,1fr)] gap-8 md:gap-12 mb-12 md:mb-16 relative z-10">
                                    <div className="space-y-4 flex flex-col items-center md:items-start">
                                        <div className="bg-white p-4 shadow-lg border border-[#F0EDEA] rotate-[-2deg] rounded-2xl overflow-hidden w-full sm:max-w-[300px] mx-auto md:mx-0">
                                            <div className="text-[10px] font-black uppercase tracking-[0.25em] opacity-40 mb-3 text-center">Card Background</div>
                                            <label className="block relative cursor-pointer group w-full sm:max-w-[240px] mx-auto">
                                                <div className="absolute inset-0 rounded-xl ring-0 group-hover:ring-2 group-hover:ring-blue-brand/20 transition-all pointer-events-none" />
                                                <div className="aspect-[3/4] bg-slate-50 rounded-xl overflow-hidden relative">
                                                    {hasCover ? (
                                                        <img
                                                            src={cover}
                                                            alt="cover preview"
                                                            className="absolute inset-0 w-full h-full grayscale"
                                                            style={{ objectFit: coverFit, objectPosition: coverPosition }}
                                                            loading="lazy"
                                                        />
                                                    ) : (
                                                        <div className="absolute inset-0 bg-gradient-to-br from-white via-[#FDFBF7] to-[#F3F1EC]" />
                                                    )}
                                                    <div className="absolute inset-0 bg-gradient-to-br from-white/50 via-transparent to-transparent pointer-events-none" />
                                                    <div className="absolute inset-0 flex items-end justify-center pb-4 pointer-events-none">
                                                        <div className="px-4 py-2 bg-white/85 border border-white rounded-full text-[10px] font-black uppercase tracking-[0.2em] opacity-70 group-hover:opacity-100 transition-opacity">
                                                            Click to upload background
                                                        </div>
                                                    </div>
                                                </div>
                                                <input
                                                    type="file"
                                                    accept="image/*"
                                                    className="hidden"
                                                    onChange={async (e) => {
                                                        const file = e.target.files?.[0];
                                                        if (!file || !detailPersona?.id) return;
                                                        try {
                                                            const url = await fileToDataURL(file);
                                                            setPersonaCoverOverrides(prev => ({ ...(prev || {}), [detailPersona.id]: url }));
                                                            setDetailPersona(prev => prev ? ({ ...prev, cover_url: url }) : prev);
                                                        } catch (err) {
                                                            console.error(err);
                                                        } finally {
                                                            e.target.value = '';
                                                        }
                                                    }}
                                                />
                                            </label>
                                            <div className="mt-4 flex items-center justify-center">
                                                <button
                                                    type="button"
                                                    onClick={() => {
                                                        if (!detailPersona?.id) return;
                                                        setPersonaCoverOverrides(prev => {
                                                            const next = { ...(prev || {}) };
                                                            delete next[detailPersona.id];
                                                            return next;
                                                        });
                                                        const baseCover = personaAssets?.[detailPersona.id]?.cover_url || null;
                                                        setDetailPersona(prev => prev ? ({ ...prev, cover_url: baseCover }) : prev);
                                                    }}
                                                    className="px-4 h-10 rounded-full bg-[#FDFBF7] border border-[#E8E6E0] text-[10px] font-black uppercase tracking-[0.2em] hover:shadow-md transition-all"
                                                >
                                                    Use default background
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex flex-col justify-center space-y-4 md:space-y-6 text-center md:text-left">
                                        <div className="flex justify-center md:justify-start">
                                            <div className="relative inline-flex">
                                                <button
                                                    type="button"
                                                    onClick={() => setPersonaIconEditorOpen(true)}
                                                    className="w-16 h-16 rounded-3xl bg-[#FDFBF7] border border-[#F0EDEA] overflow-hidden shadow-sm hover:shadow-md transition-all"
                                                    title="Edit icon"
                                                    aria-label="Edit persona icon"
                                                >
                                                    <AvatarDisplay avatar={detailPersona?.avatar} className="w-full h-full text-3xl" />
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => setPersonaIconEditorOpen(true)}
                                                    className="absolute -top-3 -right-3 w-8 h-8 rounded-full bg-white/95 backdrop-blur border border-[#F0EDEA] shadow-md hover:shadow-lg transition-all flex items-center justify-center text-blue-brand"
                                                    title="Edit icon"
                                                    aria-label="Edit persona icon"
                                                >
                                                    <Icon name="Pencil" size={15} />
                                                </button>
                                            </div>
                                        </div>
                                        <h1 className="text-4xl md:text-6xl font-black text-[#1A1A1A] italic tracking-tighter uppercase leading-tight">{detailPersona?.name}</h1>
                                        <p className="text-xs md:text-sm font-bold text-blue-brand uppercase tracking-[0.4em]">{detailPersona?.role}</p>
                                        <div className="h-px w-20 bg-blue-brand/30 mx-auto md:mx-0" />
                                        <p className="text-lg md:text-xl italic opacity-70 leading-relaxed">‚Äú{detailPersona?.worldview}‚Äù</p>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8 mb-12 font-sans text-left relative z-10">
                                    <div className="md:col-span-2 p-6 md:p-10 bg-[#FDFBF7] border-2 border-dashed border-[#D1CEC7] rounded-3xl space-y-8">
                                        <div><h3 className="text-[10px] font-black uppercase tracking-widest opacity-30 mb-6">Soul & Wisdom</h3><h4 className="text-[10px] font-black uppercase text-[#D1CEC7] tracking-widest mb-2">Decision Priorities</h4><p className="text-sm italic leading-relaxed">{detailPersona?.decisionStyle || "Grounded and reflective."}</p></div>
                                        <div className="space-y-4 pt-2">
                                            {detailPersona?.lifeContext?.map((item, idx) => (
                                                <div key={idx} className="flex gap-4"><span className="text-xs font-mono opacity-20 mt-1">[{idx+1}]</span><div><h5 className="font-bold text-sm text-[#1A1A1A]">{item.period}</h5><p className="text-xs opacity-50 italic">{item.detail}</p></div></div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="p-6 md:p-8 bg-white border border-[#F0EDEA] rounded-3xl shadow-sm text-center">
                                        <h3 className="text-[10px] font-black uppercase tracking-widest opacity-30 mb-8">Voice</h3>
                                        <p className="text-xs md:text-sm italic text-neutral-600 border-l-2 border-blue-brand/20 pl-4 py-2 text-left">{detailPersona?.voice}</p>
                                    </div>
                                </div>
                                <div className="flex flex-col md:flex-row justify-between items-center pt-8 border-t border-[#F0EDEA] gap-4 relative z-10"><p className="text-[10px] italic opacity-40 uppercase tracking-widest text-center">Observation over noise.</p><button onClick={() => { if(!selectedIds.includes(detailPersona?.id)) setSelectedIds([...selectedIds, detailPersona?.id]); setView('persona-selection'); }} className={`w-full md:w-auto px-10 py-4 rounded-full font-black uppercase tracking-widest text-[10px] transition-all shadow-xl ${selectedIds.includes(detailPersona?.id) ? 'bg-slate-200 text-slate-50' : 'bg-blue-brand text-white shadow-blue-brand/20'}`}>{selectedIds.includes(detailPersona?.id) ? 'In Panel' : 'Invite to Debate'}</button></div>
                            </div>
                        </div>
                    );
                }
                if (view === 'persona-selection') {
                    const filtered = category === 'ALL' ? displayPersonas : displayPersonas.filter(p => p.category === category);
                    return (
                        <div className="w-full flex flex-col items-center pt-8 md:pt-12 animate-in pb-32">
                            <div className="flex justify-center mb-10 px-4 w-full">
                                <div className="overflow-x-auto no-scrollbar py-4 w-full">
                                    <div className="flex justify-center px-6 md:px-10">
                                        <div className="inline-flex bg-white/60 backdrop-blur-md p-1.5 rounded-full border-2 border-white shadow-lg whitespace-nowrap">
                                            {['ALL', 'CREATIVE', 'RATIONAL', 'SUPPORT', 'CUSTOM'].map(cat => (
                                                <button
                                                    key={cat}
                                                    onClick={() => setCategory(cat)}
                                                    className={`px-4 md:px-8 py-2 md:py-3 rounded-full text-[9px] md:text-[10px] font-black uppercase tracking-[0.1em] md:tracking-[0.2em] transition-all duration-300 ${category === cat ? 'bg-blue-brand text-white shadow-lg scale-105' : 'text-[#5D576B]/40 hover:text-blue-brand'}`}
                                                >
                                                    {cat}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <h2 className="text-3xl md:text-5xl font-serif italic mb-12 md:mb-20 text-[#5D576B] text-center tracking-tight px-4">Assemble the Voices</h2>
                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 md:gap-10 px-4 md:px-8 w-full max-w-[1250px]">
                                {filtered.map(p => {
                                    const isSel = selectedIds.includes(p.id);
                                    return (
                                        <div key={p.id} onClick={() => { setDetailPersona(p); setView('persona-detail'); }} className={`relative px-6 pb-6 pt-16 md:px-8 md:pb-8 md:pt-20 bg-white rounded-[40px] shadow-xl border-2 transition-all transform hover:scale-[1.03] flex flex-col aspect-[3/4] min-h-[300px] overflow-hidden group ${isSel ? 'border-blue-brand shadow-blue-brand/10' : 'border-white/20'}`}>
                                            <button onClick={(e) => toggleSelect(e, p)} className={`absolute top-6 right-6 w-10 h-10 rounded-full border-2 flex items-center justify-center z-30 transition-all ${isSel ? 'bg-blue-brand border-blue-brand shadow-lg scale-110' : 'bg-transparent border-slate-100 group-hover:border-blue-brand/40'}`}>{isSel && <Icon name="Check" size={18} className="text-white" />}</button>
                                            <div className="absolute top-6 left-6 w-12 h-12 rounded-2xl bg-white/70 border border-white shadow-sm flex items-center justify-center overflow-hidden z-20">
                                                <AvatarDisplay avatar={p.avatar} className="w-full h-full text-2xl" />
                                            </div>
                                            <div className="flex-1" />
                                            <div className="mt-auto text-left space-y-2"><h4 className="font-black text-xl md:text-2xl text-[#1A1A1A] tracking-tighter uppercase italic">{p.name}</h4><p className="text-[7px] md:text-[8px] uppercase font-black tracking-widest text-blue-brand/80">{p.role}</p><p className="text-[10px] md:text-xs italic opacity-40 leading-relaxed line-clamp-2">‚Äú{p.worldview}‚Äù</p></div>
                                        </div>
                                    );
                                })}
                                <div onClick={() => setView('builder')} className="relative p-6 bg-white/30 backdrop-blur-sm rounded-[40px] border-2 border-dashed border-blue-brand/30 cursor-pointer transition-all hover:bg-white hover:border-blue-brand flex flex-col items-center justify-center gap-4 aspect-[3/4] min-h-[300px] text-center group"><div className="w-12 h-12 rounded-full bg-white shadow-lg flex items-center justify-center text-blue-brand group-hover:scale-110 transition-transform"><Icon name="Plus" size={24} /></div><p className="text-[9px] md:text-[10px] font-black uppercase tracking-[0.2em] opacity-40 group-hover:opacity-80 transition-opacity">Create Voice</p></div>
                            </div>
                            {selectedIds.length >= 2 && <div className="fixed bottom-8 left-1/2 -translate-x-1/2 z-40 animate-in w-[90%] md:w-auto text-center"><button onClick={() => setView('debate')} className="px-12 md:px-16 py-5 md:py-6 bg-[#1A1A1A] text-white rounded-full font-black text-[10px] md:text-xs tracking-[0.3em] md:tracking-[0.4em] shadow-2xl hover:scale-105 transition-all uppercase">Commence Dialogue</button></div>}
                        </div>
                    );
                }
                if (view === 'debate') return (
                    <DebateArena
                        context={context}
                        selectedPersonas={displayPersonas.filter(p => selectedIds.includes(p.id))}
                        setView={setView}
                        ensureSession={ensureSession}
                        persistMessage={persistMessage}
                        buildContextBlock={buildContextBlock}
                        userAvatar={userAvatar}
                    />
                );
                if (view === 'summary') return <div className="text-center py-32 md:py-48 px-4 animate-in space-y-8 md:space-y-10 max-w-2xl mx-auto"><div className="text-5xl md:text-7xl animate-bounce">üå±</div><h2 className="text-3xl md:text-5xl font-serif italic text-[#1A1A1A] tracking-tight">Pattern Observed</h2><button onClick={handleNewChat} className="px-12 md:px-16 py-5 md:py-6 bg-blue-brand text-white rounded-full font-black shadow-xl uppercase tracking-widest text-[9px] md:text-[10px] hover:shadow-2xl transition-all">Start New Chapter</button></div>;
                return (
                    <section className="space-y-6 md:space-y-10 py-10 md:py-20 px-4 max-w-3xl mx-auto w-full animate-in flex flex-col items-center">
                        <header className="mb-2 md:mb-4 text-center space-y-3"><h1 className="text-6xl md:text-8xl font-black tracking-tighter text-blue-brand uppercase italic leading-none">LIFEE</h1><p className="italic text-[8px] md:text-[10px] text-[#C1C1C1] uppercase tracking-[0.4em] md:tracking-[0.6em] font-black font-sans">YOUR LIFE & FRIEND COACH</p></header>
                        {(() => {
                            const suggestedQuestions = [
                                "I have so many hobbies, but why do I still feel empty inside?",
                                "How should young adults navigate the confusing years of their twenties?",
                                "When chasing a crush, is it better to confess directly or take it slow?",
                                "I'm approaching 30. With no house, no kids and the low cost of silence, I should seriously consider long-term development. I'm very torn about whether to leave or stay in Beijing.",
                                "For those who entered the entertainment industry because of fandom, how's life treating you now?"
                            ];
                            return (
                                <div className="w-full suggested-questions-scroll">
                                    <div className="suggested-questions-container">
                                        {suggestedQuestions.map((question, index) => (
                                            <button
                                                key={index}
                                                type="button"
                                                className="question-capsule"
                                                onClick={() => setContext({...context, situation: question})}
                                            >
                                                {question}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            );
                        })()}
                        <div className="w-full bg-white p-8 md:p-16 rounded-[40px] md:rounded-[70px] shadow-sm border border-[#F0EDEA] text-center relative overflow-hidden transition-all hover:shadow-xl"><div className="absolute top-0 right-0 p-8 md:p-12 opacity-5"><Icon name="Sparkles" size={64} /></div><h2 className="text-xl md:text-3xl font-serif italic mb-6 md:mb-10 text-[#1A1A1A] tracking-tight">‚ÄúLet them argue, you decide.‚Äù</h2><textarea className="w-full h-40 md:h-52 p-6 md:p-8 bg-[#FDFBF7]/50 rounded-[30px] md:rounded-[40px] border-2 border-transparent focus-blue-brand transition-all duration-300 focus:outline-none text-base md:text-xl leading-relaxed placeholder:italic no-scrollbar" placeholder="Describe the current tension..." value={context.situation} onChange={(e) => setContext({...context, situation: e.target.value})} /></div>
                        <div className="space-y-6 md:space-y-8 px-4 text-center w-full">
                            <h3 className="text-xs md:text-sm font-black uppercase tracking-[0.3em] text-[#5D576B]/70">WHEN IS THIS LANDING?</h3>
                            <div className="capsule-container shadow-sm">
                                {[
                                    { key: 'scenario', label: 'SCENARIO' },
                                    { key: 'problemType', label: 'PROBLEM TYPE' }
                                ].map(({ key, label }) => (
                                    <button
                                        key={key}
                                        type="button"
                                        onClick={() => setLandingTab(key)}
                                        className={`capsule-item ${landingTab === key ? 'capsule-item-active' : 'capsule-item-inactive'}`}
                                    >
                                        {label}
                                    </button>
                                ))}
                            </div>
                            <div className="animate-in pb-4" key={landingTab}>
                                <div className="flex flex-wrap justify-center gap-2 md:gap-3">
                                    {LANDING_CATEGORIES[landingTab].map(opt => {
                                        const isSel = (context.landingPeriods || []).includes(opt);
                                        return (
                                            <button
                                                key={opt}
                                                type="button"
                                                onClick={() => setContext(prev => ({ ...prev, landingPeriods: isSel ? (prev.landingPeriods || []).filter(x => x !== opt) : [...(prev.landingPeriods || []), opt] }))}
                                                className={`landing-opt ${isSel ? 'selected' : ''}`}
                                            >
                                                {opt.toUpperCase()}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                        <button disabled={!context.situation} onClick={() => setView('persona-selection')} className="w-full max-w-lg py-5 md:py-7 bg-blue-brand text-white rounded-full font-black shadow-[0_4px_14px_rgba(152,166,212,0.35)] transition-all hover:translate-y-[-2px] uppercase tracking-[0.3em] text-[10px] md:text-xs disabled:opacity-20 active:scale-95">STEP FORWARD</button>
                    </section>
                );
            };

            return (
                <div className="min-h-screen">
                    <AppLayout
                        activeView={view}
                        setView={setView}
                        user={user}
                        isAdmin={isAdmin}
                        onOpenAdmin={() => setAdminOpen(true)}
                        onLogin={() => setAuthOpen(true)}
                        onSignOut={async () => { await supabaseClient.auth.signOut(); setUser(null); }}
                        onNewChat={handleNewChat}
                    >
                        {user ? renderContent() : (
                            <div className="min-h-screen flex items-center justify-center">
                                <div className="text-center px-6">
                                    <h1 className="text-4xl font-serif italic text-[#1A1A1A] mb-4">Welcome to LIFEE</h1>
                                    <p className="text-xs uppercase tracking-[0.3em] opacity-40">Please sign in to continue</p>
                                </div>
                            </div>
                        )}
                    </AppLayout>
                    <AuthModal isOpen={authOpen || !user} onClose={() => setAuthOpen(false)} onAuthed={(u) => setUser(u)} />
                    {isAdmin && (
                        <AdminPanel
                            isOpen={adminOpen}
                            onClose={() => setAdminOpen(false)}
                            personas={displayPersonas.filter(p => !p.id.startsWith('custom-'))}
                            onRefresh={async () => {
                                const { data } = await supabaseClient.from('personas').select('id, avatar_url, cover_url');
                                const map = {};
                                (data || []).forEach(row => { map[row.id] = row; });
                                setPersonaAssets(map);
                            }}
                        />
                    )}
                    <PersonaEditModal
                        isOpen={!!editPersona}
                        persona={editPersona}
                        onClose={() => setEditPersona(null)}
                        onSave={(next) => {
                            setPersonas(prev => prev.map(p => p.id === next.id ? next : p));
                            setEditPersona(null);
                        }}
                    />
                    <PersonaIconEditorModal
                        isOpen={personaIconEditorOpen}
                        persona={detailPersona}
                        onClose={() => setPersonaIconEditorOpen(false)}
                        onSetAvatar={(value) => {
                            if (!detailPersona?.id) return;
                            setPersonaAvatarOverrides(prev => ({ ...(prev || {}), [detailPersona.id]: value }));
                            setDetailPersona(prev => prev ? ({ ...prev, avatar: value }) : prev);
                        }}
                        onUseDefault={() => {
                            if (!detailPersona?.id) return;
                            setPersonaAvatarOverrides(prev => {
                                const next = { ...(prev || {}) };
                                delete next[detailPersona.id];
                                return next;
                            });
                            const base = personaAssets?.[detailPersona.id]?.avatar_url || personas.find(x => x.id === detailPersona.id)?.avatar || 'üë§';
                            setDetailPersona(prev => prev ? ({ ...prev, avatar: base }) : prev);
                        }}
                    />
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
